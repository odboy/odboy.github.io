<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="MacOS的内核属于Unix，而在Unix中并没有iptables，而是pf(packet filter)。">
<meta name="keywords" content="pf">
<meta property="og:type" content="article">
<meta property="og:title" content="OpenBSD PF(Packet Filter)学习">
<meta property="og:url" content="https://oddboy.cn/2018/OpenBSD-PF-Packet-Filter-学习/index.html">
<meta property="og:site_name" content="Mr.Bingo&#39;s Blog">
<meta property="og:description" content="MacOS的内核属于Unix，而在Unix中并没有iptables，而是pf(packet filter)。">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-03-13T06:36:07.635Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="OpenBSD PF(Packet Filter)学习">
<meta name="twitter:description" content="MacOS的内核属于Unix，而在Unix中并没有iptables，而是pf(packet filter)。">






  <link rel="canonical" href="https://oddboy.cn/2018/OpenBSD-PF-Packet-Filter-学习/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>OpenBSD PF(Packet Filter)学习 | Mr.Bingo's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Mr.Bingo's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">The world is a narrow bridge, and the most important thing is not to be afraid.</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    
  
  
  
  

  

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL29kYm95" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill: #222; color: #fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></span>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://oddboy.cn/2018/OpenBSD-PF-Packet-Filter-学习/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr.Bingo">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mr.Bingo's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">OpenBSD PF(Packet Filter)学习

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-01-25 15:22:35" itemprop="dateCreated datePublished" datetime="2018-01-25T15:22:35+08:00">2018-01-25</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-03-13 14:36:07" itemprop="dateModified" datetime="2019-03-13T14:36:07+08:00">2019-03-13</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>MacOS的内核属于Unix，而在Unix中并没有iptables，而是pf(packet filter)。<br><a id="more"></a></p>
<h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><h3 id="激活"><a href="#激活" class="headerlink" title="激活"></a>激活</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; pfctl -e  <span class="comment"># 启动PF</span></span><br><span class="line">&gt; pfctl -d  <span class="comment"># 关闭PF</span></span><br></pre></td></tr></table></figure>
<p>注意，这仅仅只是启动和关闭PF，实际不会载入规则集(ruleset)。规则集需要单独载入，或者在启动时载入。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>系统启动时会从<code>/etc/pf.conf</code>（默认配置文件）载入配置规则。对于其他的规则，可以在运行过程中载入，具备足够的灵活性。</p>
<p><code>/etc/pf.conf</code>文件有7个部分：</p>
<ul>
<li>Macros(宏):用户定义的变量，包括IP地址，接口名称等等 </li>
<li>Tables(表): 一种用来保存IP地址列表的结构 </li>
<li>Options(选项): 控制PF如何工作的变量 </li>
<li>Scrub(整形): 重新处理数据包，进行正常化和碎片整理 </li>
<li>Queue(排队): 提供带宽控制和数据包优先级控制</li>
<li>Translation(转换): 控制网络地址转换和数据包重定向</li>
<li>Filter Rules(过滤规则): 在数据包通过接口时允许进行选择性的过滤和阻止 </li>
</ul>
<blockquote>
<p>  除去宏和表，其他的部分在配置文件中应该按照如上顺序出现，否则会报错。<br>  空行会被忽略，<code>#</code> 为行注释符。</p>
</blockquote>
<h3 id="控制"><a href="#控制" class="headerlink" title="控制"></a>控制</h3><p>通过pfctl对pf进行管理，示例如下：</p>
<ul>
<li>pfctl -f /etc/pf.conf 载入 pf.conf 文件 </li>
<li>pfctl -nf /etc/pf.conf 解析文件，但不载入 </li>
<li>pfctl -Nf /etc/pf.conf 只载入文件中的NAT规则 </li>
<li><p>pfctl -Rf /etc/pf.conf 只载入文件中的过滤规则 </p>
</li>
<li><p>pfctl -sn 显示当前的NAT规则 </p>
</li>
<li>pfctl -sr 显示当前的过滤规则 </li>
<li>pfctl -ss 显示当前的状态表 </li>
<li>pfctl -si 显示过滤状态和计数 </li>
<li>pfctl -sa 显示任何可显示的 </li>
</ul>
<p>完整命令查看man手册。</p>
<h2 id="列表和宏"><a href="#列表和宏" class="headerlink" title="列表和宏"></a>列表和宏</h2><h3 id="列表-Lists"><a href="#列表-Lists" class="headerlink" title="列表 - Lists"></a>列表 - Lists</h3><p>使用<code>{}</code>大括号将相似条目（协议、端口、地址等）括起来，条目之间的逗号可有可无。 如：</p>
<p><code>block out on en0 from { 192.168.0.1, 10.5.32.6 } to any</code></p>
<h3 id="宏-Macros"><a href="#宏-Macros" class="headerlink" title="宏 - Macros"></a>宏 - Macros</h3><p>宏是用户定义的变量，用来指定IP地址、端口、接口等等。一次配置，多处使用。 </p>
<p>宏名称以字母开头，可以包括字母，数字和下划线，不能为关键字。 引用时，在宏名称前加<code>$</code>。</p>
<h2 id="表-Table"><a href="#表-Table" class="headerlink" title="表 - Table"></a>表 - Table</h2><p>表用来存储IP地址的，特点是比列表快且剩资源。</p>
<h3 id="表配置"><a href="#表配置" class="headerlink" title="表配置"></a>表配置</h3><p>使用table关键字创建表，表名总是被<code>&lt;&gt;</code>符号括起来。如下关键字必须在创建表时指定： </p>
<ul>
<li>constant - 这类表得内容一旦创建出来就不能被改变。如果这个属性没有指定，可以使用pfctl添加和删除表里的地址。</li>
<li>persist - 即使没有规则引用这类表，内核也会把它保留在内存中。如果这个属性没有指定，当最后引用它的规则被取消后内核自动把它移出内存。 </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pf.conf</span></span><br><span class="line">table &lt;goodguys&gt; &#123; 192.0.2.0/24 &#125;   <span class="comment">#建表</span></span><br><span class="line">table &lt;spammers&gt; persist file <span class="string">"/etc/spammers"</span>   <span class="comment"># 从文件中加载条目</span></span><br><span class="line">pass <span class="keyword">in</span> on en0 from &lt;goodguys&gt; to any   <span class="comment"># 使用</span></span><br></pre></td></tr></table></figure>
<h3 id="命令操作"><a href="#命令操作" class="headerlink" title="命令操作"></a>命令操作</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; pfctl -t spammers -T add 218.70.0.0/16    <span class="comment"># 在spammers表中添加条目</span></span><br><span class="line">&gt; pfctl -t spammers -T show     <span class="comment"># 显示</span></span><br><span class="line">&gt; pfctl -t spammers -T delete 218.70.0.0/16</span><br></pre></td></tr></table></figure>
<h3 id="指定地址"><a href="#指定地址" class="headerlink" title="指定地址"></a>指定地址</h3><p>除了使用IP地址外，也可以使用主机名指定主机（会被解析为IP地址）</p>
<h3 id="地址匹配"><a href="#地址匹配" class="headerlink" title="地址匹配"></a>地址匹配</h3><p>表中多条规则，地址查询时匹配最接近的规则。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">table &lt;goodguys&gt; &#123; 172.16.0.0/16, !172.16.1.0/24, 172.16.1.100 &#125; </span><br><span class="line">block in on dc0 all </span><br><span class="line">pass in on dc0 from &lt;goodguys&gt; to any</span><br></pre></td></tr></table></figure></p>
<p>任何自dc0上数据包都会把它的源地址和goodguys表中的地址进行匹配： </p>
<ul>
<li>172.16.50.5 - 精确匹配172.16.0.0/16; 数据包符合可以通过 </li>
<li>172.16.1.25 - 精确匹配!172.16.1.0/24; 数据包匹配表中的一条规则，但规则是“非”（使用“！”进行了修改）；数据包不匹配表会被阻塞。 </li>
<li>172.16.1.100 - 准确匹配172.16.1.100; 数据包匹配表，运行通过 </li>
<li>10.1.4.55 - 不匹配表，阻塞。 </li>
</ul>
<h2 id="包过滤"><a href="#包过滤" class="headerlink" title="包过滤"></a>包过滤</h2><p>包过滤是在数据包通过网络接口时进行选择性的<code>pass</code>或者<code>block</code>。pf检查包时使用的标准是基于的3层（IPV4或者IPV6）和4层（TCP, UDP, ICMP, ICMPv6）包头。最常用的标准地址、端口、协议。</p>
<p>规则集指定数据包在规则集匹配时通过或者阻塞。规则集从前往后顺序执行。除非数据包匹配的规则包含<code>quick</code>关键字，否则数据包在最终执行动作前会通过所有的规则检验。最后匹配的规则具有决定性，决定了数据包最终的执行结果。</p>
<p>一条潜规则： <code>如果数据包和规则集中的所有规则都不匹配，则它会被pass。</code></p>
<h3 id="规则语法"><a href="#规则语法" class="headerlink" title="规则语法"></a>规则语法</h3><p><code>action direction [log] [quick] on interface [af] [proto protocol] from src_addr [port src_port] to dst_addr [port dst_port] [tcp_flags] [state]</code></p>
<ul>
<li><p>action</p>
<blockquote>
<p>  <strong><code>pass</code></strong> 数据包传递给核心进行进一步处理。<br>  <strong><code>block</code></strong> 根据<code>block-policy</code>选项指定的方法进行处理。默认的动作可以修改为阻塞丢弃或者阻塞返回。 </p>
</blockquote>
</li>
<li><p>direction</p>
<blockquote>
<p>  <strong><code>in</code></strong>    进来<br>  <strong><code>out</code></strong>   出去</p>
</blockquote>
</li>
<li><p>log</p>
<blockquote>
<p>  指定数据包被<code>pflogd</code>(进行日志记录。如果规则指定了<code>keep state</code>, <code>modulate state</code>,<code>synproxy state</code> 选项，则只有建立了连接的状态被记录，<code>log-all</code>记录所有日志。</p>
</blockquote>
</li>
<li><p>quick</p>
<blockquote>
<p>  如果数据包匹配的规则指定了 <code>quick</code> 关键字，则这条规则被认为时最终的匹配规则，指定的动作会立即执行。 </p>
</blockquote>
</li>
<li><p>interface</p>
<blockquote>
<p>  数据包通过的网络接口的名称或组。组是接口的名称但没有最后的整数。比如ppp 或 fxp，会使得规则分别匹配任何ppp或者fxp接口上的任意数据包。</p>
</blockquote>
</li>
<li><p>af</p>
<blockquote>
<p>  <code>Address Family</code> IPv4 或者 IPv6。 通常自动识别，不用管。</p>
</blockquote>
</li>
<li><p>protocol</p>
<blockquote>
<p>  <code>/etc/protocols</code> 中的协议名称 /<br>  <code>0-255</code> 的协议号</p>
</blockquote>
</li>
<li><p>src_addr / dst_addr</p>
<blockquote>
<p>  各种地址: ip/CIDR/域名/网络接口名称/带掩码的网络接口名称/带括号()的网络接口名称(自动更新接口IP)<br>  /其它（看不懂的部分不管）</p>
</blockquote>
</li>
<li><p>src_port, dst_port</p>
<blockquote>
<p>  1-65535/<code>/etc/services</code>中的名称/端口list/范围（!= &lt; &gt; &lt;= &gt;= &lt;&gt; &gt;&lt;）</p>
</blockquote>
</li>
<li><p>tcp_flags </p>
<blockquote>
<p>  指定使用TCP协议时TCP头中必须设定的标记。 标记指定的格式是： <code>flags check/mask</code>，例如: flags S/SA -这指引PF只检查S和A(SYN and ACK)标记，如果SYN标记是“on”则匹配。 OpenBSD 4.1之后，<code>flags S/SA</code> 默认应用到TCP的过滤规则。</p>
</blockquote>
</li>
<li><p>state</p>
<blockquote>
<p>  指定状态信息在规则匹配时是否保持。<br>  <code>keep state</code> - 对 TCP, UDP, ICMP起作用。<code>modulate state</code> - 只对 TCP起作用。PF会为匹配规则的数据包产生强壮的初始化序列号。 <code>synproxy state</code> - 代理外来的TCP连接以保护服务器不受TCP SYN FLOODs欺骗。这个选项包含了keep state 和 modulate state 的功能。 </p>
</blockquote>
</li>
</ul>
<h3 id="默认拒绝"><a href="#默认拒绝" class="headerlink" title="默认拒绝"></a>默认拒绝</h3><p>为了安全，可以配置默认拒绝。 在过滤规则的开头配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">block in all </span><br><span class="line">block out all</span><br></pre></td></tr></table></figure></p>
<h3 id="通过流量"><a href="#通过流量" class="headerlink" title="通过流量"></a>通过流量</h3><p>流量必须被明确的允许通过防火墙或者被默认拒绝的策略丢弃。</p>
<h3 id="quick关键字"><a href="#quick关键字" class="headerlink" title="quick关键字"></a><code>quick</code>关键字</h3><p>匹配后立即执行。</p>
<h3 id="状态保持"><a href="#状态保持" class="headerlink" title="状态保持"></a>状态保持</h3><p>PF一个非常重要的功能是“状态保持”或者“状态检测”。状态检测指PF跟踪或者处理网络连接状态的能力。通过存贮每个连接的信息到一个状态表中，PF能够快速确定一个通过防火墙的数据包是否属于已经建立的连接。如果是，它会直接通过防火墙而不用再进行规则检验。</p>
<p>从OpenBSD 4.1开始，所有的过滤规则自动添加<code>keep state</code></p>
<p><code>modulate state</code>(状态调整) – 搞不懂</p>
<h3 id="UDP状态保持"><a href="#UDP状态保持" class="headerlink" title="UDP状态保持"></a>UDP状态保持</h3><p>大家都听说过，“不能为UDP产生状态，因为UDP是无状态的协议”。确实，UDP通信会话没有状态的概念（明确的开始和结束通信），这丝毫不影响PF为 UDP会话产生状态的能力。对于没有开始和结束数据包的协议，PF仅简单追踪匹配的数据部通过的时间。如果到达超时限制，状态被清除，超时的时间值可以在 pf.conf配置文件中设定。 </p>
<h3 id="状态跟踪"><a href="#状态跟踪" class="headerlink" title="状态跟踪"></a>状态跟踪</h3><p>对连接状态进行控制管理。</p>
<ul>
<li>max number<blockquote>
<p>  限制连接数</p>
</blockquote>
</li>
<li>no state<blockquote>
<p>  禁止创建状态保持</p>
</blockquote>
</li>
<li><p>source-track</p>
<blockquote>
<p>  <code>source-track rule</code> 限制由特定规则产生的状态条目数量，由<code>max-src-nodes</code>和<code>max-src-states</code>共同决定。</p>
<p>  <code>source-track global</code> 全局限制状态条目数量。通过<code>src-nodes</code>控制全局跟踪的源IP地址总数。</p>
</blockquote>
</li>
<li><p>max-src-nodes number</p>
<blockquote>
<p>  使用<code>source-track</code>的情况下，限制原IP数量。</p>
</blockquote>
</li>
<li>max-src-states number<blockquote>
<p>  使用<code>source-track</code>的情况下，限制单IP的连接数量。</p>
</blockquote>
</li>
</ul>
<p>示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pass in on $ext_if proto tcp to $web_server port www keep state (max 200, source-track rule, max-src-nodes 100, max-src-states 3)</span><br></pre></td></tr></table></figure></p>
<ul>
<li>max-src-conn number<blockquote>
<p>  Limit the maximum number of simultaneous TCP connections which have completed the 3-way handshake that a single host can make.</p>
</blockquote>
</li>
<li>max-src-conn-rate number / interval<blockquote>
<p>  限制新连接的建立速度。</p>
</blockquote>
</li>
<li>overload \&lt;table><blockquote>
<p>  把有问题的主机的IP地址放到指定的表中。</p>
</blockquote>
</li>
<li>flush [global]<blockquote>
<p>  关闭任何符合此规则并由此源IP创建的其他状态。当指定全局时，不管哪个规则创建该状态，都将终止与该源IP匹配的所有状态。</p>
</blockquote>
</li>
</ul>
<p>示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">table &lt;abusive_hosts&gt; persist</span><br><span class="line">block in quick from &lt;abusive_hosts&gt;</span><br><span class="line">pass in on $ext_if proto tcp to $web_server port www flags S/SA keep state (max-src-conn 100, max-src-conn-rate 15/5, overload &lt;abusive_hosts&gt; flush)</span><br></pre></td></tr></table></figure></p>
<h3 id="TCP标记"><a href="#TCP标记" class="headerlink" title="TCP标记"></a>TCP标记</h3><p>基于标记的TCP包匹配经常被用于过滤试图打开新连接的TCP数据包。TCP标记和他们的意义如下所列： </p>
<ul>
<li>F : FIN - 结束; 结束会话 </li>
<li>S : SYN - 同步; 表示开始会话请求 </li>
<li>R : RST - 复位;中断一个连接 </li>
<li>P : PUSH - 推送; 数据包立即发送 </li>
<li>A : ACK - 应答 </li>
<li>U : URG - 紧急 </li>
<li>E : ECE - 显式拥塞提醒回应 </li>
<li>W : CWR - 拥塞窗口减少 </li>
</ul>
<p>默认 <code>flags S/SA</code>。 【比较复杂，略过】</p>
<h3 id="TCP-SYN-代理-（os-X下不稳定）"><a href="#TCP-SYN-代理-（os-X下不稳定）" class="headerlink" title="TCP SYN 代理 （os X下不稳定）"></a>TCP SYN 代理 （os X下不稳定）</h3><p>就是代理握手，防止<code>TCP SYN FLOOD</code> DOS攻击.   由于synproxy state工作的方式，它具有keep state 和 modulate state一样的功能。 如果PF工作在桥接模式下，SYN代理不会起作用(不懂)。</p>
<p>示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pass in on $ext_if proto tcp from any to $web_server port www flags S/SA synproxy state</span><br></pre></td></tr></table></figure></p>
<h3 id="阻塞欺骗数据包"><a href="#阻塞欺骗数据包" class="headerlink" title="阻塞欺骗数据包"></a>阻塞欺骗数据包</h3><p>地址欺骗相关，，，，  忽略。</p>
<h3 id="Unicast-Reverse-Path-Forwarding"><a href="#Unicast-Reverse-Path-Forwarding" class="headerlink" title="Unicast Reverse Path Forwarding"></a>Unicast Reverse Path Forwarding</h3><p>OpenBSD 4.0引入，类似于交换机的端口MAC地址绑定，避免ARP欺骗。<br>固定使用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">block in quick from urpf-failed label uRPF</span><br></pre></td></tr></table></figure></p>
<h3 id="被动操作系统识别"><a href="#被动操作系统识别" class="headerlink" title="被动操作系统识别"></a>被动操作系统识别</h3><p>被动操作系统识别是通过基于远端主机TCP SYN数据包中某些特征进行操作系统被动检测的技术。这些信息可以作为标准在过滤规则中使用。PF检测远端操作系统是通过比较TCP SYN数据包中的特征和已知的特征文件对照来确定的，特征文件默认是/etc/pf.os。如果PF起作用，可是使用下面的命令查看当前的特征列表。<br><code>pfctl -s osfp</code></p>
<p>使用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pass in on $ext_if any os OpenBSD keep state </span><br><span class="line">block in on $ext_if any os &quot;Windows 2000&quot; </span><br><span class="line">block in on $ext_if any os &quot;Linux 2.4 ts&quot; </span><br><span class="line">block in on $ext_if any os unknown</span><br></pre></td></tr></table></figure></p>
<h3 id="IP-选项"><a href="#IP-选项" class="headerlink" title="IP 选项"></a>IP 选项</h3><p>默认情况下，PF阻塞带有IP选项得数据包。这可以使得类似nmap得操作系统识别软件工作困难。如果你的应用程序需要通过这样的数据包，例如多播或者IGMP，你可以使用allow-opts关键字。<br><code>pass in quick on fxp0 all allow-opts</code></p>
<h3 id="过滤规则实例"><a href="#过滤规则实例" class="headerlink" title="过滤规则实例"></a>过滤规则实例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">ext_if = <span class="string">"fxp0"</span></span><br><span class="line">int_if = <span class="string">"dc0"</span></span><br><span class="line">lan_net = <span class="string">"192.168.0.0/24"</span></span><br><span class="line"><span class="comment"># table containing all IP addresses assigned to the firewall</span></span><br><span class="line">table &lt;firewall&gt; const &#123; self &#125;</span><br><span class="line"><span class="comment"># don't filter on the loopback interface</span></span><br><span class="line"><span class="built_in">set</span> skip on lo0</span><br><span class="line"><span class="comment"># scrub incoming packets</span></span><br><span class="line">scrub <span class="keyword">in</span> all</span><br><span class="line"><span class="comment"># setup a default deny policy</span></span><br><span class="line">block all</span><br><span class="line"><span class="comment"># activate spoofing protection for all interfaces</span></span><br><span class="line">block <span class="keyword">in</span> quick from urpf-failed</span><br><span class="line"><span class="comment"># only allow ssh connections from the local network if it's from the</span></span><br><span class="line"><span class="comment"># trusted computer, 192.168.0.15. use "block return" so that a TCP RST is # sent to close blocked connections right away. use "quick" so that this # rule is not overridden by the "pass" rules below.</span></span><br><span class="line">block <span class="built_in">return</span> <span class="keyword">in</span> quick on <span class="variable">$int_if</span> proto tcp from ! 192.168.0.15 \</span><br><span class="line">to <span class="variable">$int_if</span> port ssh</span><br><span class="line"><span class="comment"># pass all traffic to and from the local network.</span></span><br><span class="line"><span class="comment"># these rules will create state entries due to the default</span></span><br><span class="line"><span class="comment"># "keep state" option which will automatically be applied.</span></span><br><span class="line">pass <span class="keyword">in</span> on <span class="variable">$int_if</span> from <span class="variable">$lan_net</span> to any</span><br><span class="line">pass out on <span class="variable">$int_if</span> from any to <span class="variable">$lan_net</span></span><br><span class="line"><span class="comment"># pass tcp, udp, and icmp out on the external (Internet) interface. # tcp connections will be modulated, udp/icmp will be tracked</span></span><br><span class="line"><span class="comment"># statefully.</span></span><br><span class="line">pass out on <span class="variable">$ext_if</span> proto &#123; tcp udp icmp &#125; all modulate state</span><br><span class="line"><span class="comment"># allow ssh connections in on the external interface as long as they're</span></span><br><span class="line"><span class="comment"># NOT destined for the firewall (i.e., they're destined for a machine on</span></span><br><span class="line"><span class="comment"># the local network). log the initial packet so that we can later tell</span></span><br><span class="line"><span class="comment"># who is trying to connect. use the tcp syn proxy to proxy the connection. # the default flags "S/SA" will automatically be applied to the rule by PF.</span></span><br><span class="line">pass <span class="keyword">in</span> <span class="built_in">log</span> on <span class="variable">$ext_if</span> proto tcp from any to ! &lt;firewall&gt; \</span><br><span class="line">port ssh synproxy state</span><br></pre></td></tr></table></figure>
<h2 id="NAT-网络地址转换"><a href="#NAT-网络地址转换" class="headerlink" title="NAT(网络地址转换)"></a>NAT(网络地址转换)</h2><p>NAT就是NAT。<br>NAT允许使用RFC1918中定义的保留地址族： </p>
<ul>
<li>10.0.0.0/8 (10.0.0.0 - 10.255.255.255) </li>
<li>172.16.0.0/12 (172.16.0.0 - 172.31.255.255) </li>
<li>192.168.0.0/16 (192.168.0.0 - 192.168.255.255) </li>
</ul>
<h3 id="NAT如何工作"><a href="#NAT如何工作" class="headerlink" title="NAT如何工作"></a>NAT如何工作</h3><p>NAT转换表。</p>
<h3 id="NAT和包过滤"><a href="#NAT和包过滤" class="headerlink" title="NAT和包过滤"></a>NAT和包过滤</h3><p>转换后的数据包仍然会通过过滤引擎，根据定义的过滤规则进行阻塞或者通过。唯一的例外是如果nat规则中使用了pass关键字，会使得经过nat的数据包直接通过过滤引擎。 </p>
<p>还要注意由于转换是在过滤之前进行，过滤引擎所看到的是经过转换后的ip地址和端口的数据包。</p>
<h3 id="IP转发"><a href="#IP转发" class="headerlink" title="IP转发"></a>IP转发</h3><p>实现该功能需要转发数据，所以需要如下配置。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; sysctl -w net.inet.ip.forwarding=1 </span><br><span class="line">&gt; sysctl -w net.inet6.ip6.forwarding=1 (if using IPv6)</span><br></pre></td></tr></table></figure></p>
<p>以上配置是临时生效，可以增加如下行到<code>/etc/sysctl.conf</code>文件中，可长期有效。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net.inet.ip.forwarding=1 </span><br><span class="line">net.inet6.ip6.forwarding=1</span><br></pre></td></tr></table></figure></p>
<h3 id="配置NAT"><a href="#配置NAT" class="headerlink" title="配置NAT"></a>配置NAT</h3><p><code>nat [pass] on interface [af] from src_addr [port src_port] to dst_addr [port dst_port] -&gt; ext_addr [pool_type] [static-port]</code></p>
<p>示例1： 正确，但不推荐。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nat on tl0 from 192.168.1.0/24 to any -&gt; 24.5.0.5</span><br></pre></td></tr></table></figure></p>
<p>示例2：推荐用法(tl0为外部网卡，dc0为内部网卡,<code>dc0:network</code>表示dc0的整个网段。<code>(tl0)</code>表示当tl0网卡的IP变动时，可以更新到规则库中。)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nat on tl0 from dc0:network to any -&gt; (tl0)</span><br></pre></td></tr></table></figure></p>
<h3 id="双向映射-1-1-映射"><a href="#双向映射-1-1-映射" class="headerlink" title="双向映射 (1:1 映射)"></a>双向映射 (1:1 映射)</h3><p>双向映射可以通过使用binat规则建立。Binat规则建立一个内部地址和外部地址一对一的映射。和NAT规则不同，binat规则中的tcp和udp端口不会被修改。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">web_serv_int = <span class="string">"192.168.1.100"</span> </span><br><span class="line">web_serv_ext = <span class="string">"24.5.0.6"</span> </span><br><span class="line">binat on tl0 from <span class="variable">$web_serv_int</span> to any -&gt; <span class="variable">$web_serv_ext</span></span><br></pre></td></tr></table></figure></p>
<h3 id="转换规则例外"><a href="#转换规则例外" class="headerlink" title="转换规则例外"></a>转换规则例外</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">no nat on tl0 from 192.168.1.10 to any </span><br><span class="line">nat on tl0 from 192.168.1.0/24 to any -&gt; 24.2.74.79</span><br></pre></td></tr></table></figure>
<h3 id="检查-NAT-状态"><a href="#检查-NAT-状态" class="headerlink" title="检查 NAT 状态"></a>检查 NAT 状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pfctl -s state</span><br></pre></td></tr></table></figure>
<h2 id="重定向-端口转发"><a href="#重定向-端口转发" class="headerlink" title="重定向 (端口转发)"></a>重定向 (端口转发)</h2><p>外网流量转发到NAT网关内的主机。<br>例如：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rdr on tl0 proto tcp from 27.146.49.14 to any port 80 -&gt; 192.168.1.20 </span><br><span class="line">rdr on tl0 proto tcp from 16.114.4.89 to any port 80 -&gt; 192.168.1.22 </span><br><span class="line">rdr on tl0 proto tcp from 24.2.74.178 to any port 80 -&gt; 192.168.1.23</span><br></pre></td></tr></table></figure></p>
<h3 id="重定向和包过滤"><a href="#重定向和包过滤" class="headerlink" title="重定向和包过滤"></a>重定向和包过滤</h3><p>注意：转换后的数据包仍然会通过过滤引擎，根据定义的过滤规则进行阻塞或者通过。唯一的例外是如果rdr规则中使用了pass关键字，会使得重定向的数据包直接通过过滤引擎。 </p>
<p>还要注意由于转换是在过滤之前进行，过滤引擎所看到的是在匹配rdr规则经过转换后的目标ip地址和端口的数据包。 </p>
<p><code>rdr on tl0 proto tcp from 192.0.2.1 to 24.65.1.13 port 80 -&gt; 192.168.1.5 port 8000</code></p>
<p>rdr前 ：192.0.2.1(某随机端口) –&gt; 24.65.1.13:80</p>
<p>rdr后 ：192.0.2.1(某随机端口) –&gt; 192.168.1.5:8000</p>
<h3 id="安全隐患-略"><a href="#安全隐患-略" class="headerlink" title="安全隐患(略)"></a>安全隐患(略)</h3><h3 id="重定向和反射"><a href="#重定向和反射" class="headerlink" title="重定向和反射"></a>重定向和反射</h3><p>通常，重定向规则是用来将因特网上到来的连接转发到一个内部网络或者局域网的私有地址。例如：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server = 192.168.1.40 </span><br><span class="line">rdr on <span class="variable">$ext_if</span> proto tcp from any to <span class="variable">$ext_if</span> port 80 -&gt; <span class="variable">$server</span> port 80</span><br></pre></td></tr></table></figure></p>
<p>但是，当一个重定向规则被从局域网上的客户端进行测试时，它不会正常工作。这是因为重定向规则仅适用于通过指定端口（上述例子中的外部端口$ext_if）的数据包。从局域网上的主机连接防火墙的外部地址，并不意味着数据包会实际的通过外部接口。防火墙上的TCP/IP栈会把到来的数据包的目的地址 在通过内部接口时与它自己的IP地址或者别名进行对比检测。那样的<strong>数据包不会真的通过外部接口</strong>，栈在任何情况下也不会建立那样的通道。因而，PF永远也不会在外部接口上看到那些数据包，过滤规则由于指定了外部接口也不会起作用。 </p>
<p>即使为内部接口配置重定向规则也达不到预期效果。当本地的客户端连接防火墙的外部地址时，初始化的TCP握手数据包是通过内部接口到达防火墙的。重定向规则 确实起作用了，目标地址被替换成了内部服务器，数据包通过内部接口转发到了内部的服务器。但<strong>源地址没有进行转换</strong>，仍然包含的是本地客户端的IP地址，因此 服务器把它的回应直接发送给了客户端。防火墙永远收不到应答不可能返回客户端信息，客户端收到的应答不是来自它期望的源（防火墙）会被丢弃，TCP握手失败，不能建立连接。</p>
<p>针对如上问题，有如下解决方案：</p>
<ul>
<li><p>水平分割 DNS </p>
<blockquote>
<p>  针对内网和外网配置不同的DNS解析结果。 </p>
</blockquote>
</li>
<li><p>将服务器移到独立的本地网络 </p>
<blockquote>
<p>  增加单独的网络接口卡到防火墙，把本地的服务器从和客户端同一个网段移动到专用的网段（DMZ）可以让本地客户端按照外部重定向连接的方法一样重定向。</p>
</blockquote>
</li>
<li><p>TCP 代理 </p>
<blockquote>
<p>  在防火墙上设置一个TCP代理用于接收请求，同时额外建立一条与目标服务器的连接，从而充当起中转者的角色。<br>  简单的代理可以使用 <code>inetd</code> 和 <code>nc</code> 建立。下面的 <code>/etc/inetd.conf</code> 中的条目建立一个监听套接字绑定到lookback地址（127.0.0.1）和端口5000。连接被转发到服务器192.168.1.10的80端口。 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:5000 stream tcp nowait nobody /usr/bin/nc nc -w 20 192.168.1.10 80</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ul>
<blockquote>
<p>  下面的重定向规则转发内部接口的80端口到代理：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rdr on <span class="variable">$int_if</span> proto tcp from <span class="variable">$int_net</span> to <span class="variable">$ext_if</span> port 80 -&gt; 127.0.0.1 port 5000</span><br></pre></td></tr></table></figure></p>
</blockquote>
<ul>
<li>RDR和NAT结合<blockquote>
<p>  通过对内部接口增加NAT规则，上面说的转换后源地址不变的问题可以解决。 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rdr on <span class="variable">$int_if</span> proto tcp from <span class="variable">$int_net</span> to <span class="variable">$ext_if</span> port 80 -&gt; <span class="variable">$server</span> </span><br><span class="line">no nat on <span class="variable">$int_if</span> proto tcp from <span class="variable">$int_if</span> to <span class="variable">$int_net</span> </span><br><span class="line">nat on <span class="variable">$int_if</span> proto tcp from <span class="variable">$int_net</span> to <span class="variable">$server</span> port 80 -&gt; <span class="variable">$int_if</span></span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ul>
<blockquote>
<p>  这会导致由客户端发起的初始化连接在收到内部接口的返回数据包时转换回来，客户端的源ip地址被防火墙的内部接口地址代替。内部服务器会回应防火墙的内部 接口地址，在转发给本地客户端时可以反转NAT和RDR。这个结构是非常复杂的，因为它为每个反射连接产生了2个单独的状态。必须小心配置防止NAT规则 应用到了其他流量，例如连接由外部发起（通过其他的重定向）或者防火墙自己。注意上面的rdr规则会导致TCP/IP栈看到来自内部接口带有目的地址是内部网络的数据包。 </p>
</blockquote>
<h2 id="规则生成捷径"><a href="#规则生成捷径" class="headerlink" title="规则生成捷径"></a>规则生成捷径</h2><p>PF提供了许多方法来进行规则集的简化。一些好的例子是使用宏和列表。另外，规则集的语言或者语法也提供了一些使规则集简化的捷径。首要的规则是，规则集越简单，就越容易理解和维护。 </p>
<h3 id="使用宏-略"><a href="#使用宏-略" class="headerlink" title="使用宏 (略)"></a>使用宏 (略)</h3><h3 id="使用列表-略"><a href="#使用列表-略" class="headerlink" title="使用列表 (略)"></a>使用列表 (略)</h3><h3 id="PF-语法"><a href="#PF-语法" class="headerlink" title="PF 语法"></a>PF 语法</h3><ul>
<li><p>减少关键字 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 原语法</span></span><br><span class="line">block <span class="keyword">in</span> all </span><br><span class="line">block out all</span><br><span class="line"><span class="comment"># 简化语法 没有指明方向即为双向。</span></span><br><span class="line">block all </span><br><span class="line"><span class="comment"># ---------------------------------</span></span><br><span class="line"><span class="comment"># 原语法</span></span><br><span class="line">block <span class="keyword">in</span> on rl0 all </span><br><span class="line">pass <span class="keyword">in</span> quick <span class="built_in">log</span> on rl0 proto tcp from any to any port 22 keep state </span><br><span class="line"><span class="comment"># 简化语法  "from any to any" 和 "all" 在规则中省略。</span></span><br><span class="line">block <span class="keyword">in</span> on rl0 </span><br><span class="line">pass <span class="keyword">in</span> quick <span class="built_in">log</span> on rl0 proto tcp to port 22 keep state</span><br></pre></td></tr></table></figure>
</li>
<li><p>Return 简化  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用于阻塞数据包，回应TCP RST或者ICMP不可到达的规则集。 </span></span><br><span class="line">block <span class="keyword">in</span> all </span><br><span class="line">block <span class="built_in">return</span>-rst <span class="keyword">in</span> proto tcp all </span><br><span class="line">block <span class="built_in">return</span>-icmp <span class="keyword">in</span> proto udp all </span><br><span class="line">block out all </span><br><span class="line">block <span class="built_in">return</span>-rst out proto tcp all </span><br><span class="line">block <span class="built_in">return</span>-icmp out proto udp all </span><br><span class="line"><span class="comment"># 简化语法 当PF看到return关键字，PF可以智能回复合适应答，或者完全不回复，取决于要阻塞的数据包使用的协议</span></span><br><span class="line">block <span class="built_in">return</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>关键字顺序 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在大多数情况下，关键字的顺序是非常灵活的。</span></span><br><span class="line">pass <span class="keyword">in</span> <span class="built_in">log</span> quick on rl0 proto tcp to port 22 flags S/SA keep state queue ssh label ssh </span><br><span class="line"><span class="comment"># 也可以这么写</span></span><br><span class="line">pass <span class="keyword">in</span> quick <span class="built_in">log</span> on rl0 proto tcp to port 22 queue ssh keep state label ssh flags S/SA</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="运行选项"><a href="#运行选项" class="headerlink" title="运行选项"></a>运行选项</h2><p>运行选项是控制pf操作的选择。这些选项在pf.conf中使用set指定。</p>
<h3 id="set-block-policy-option"><a href="#set-block-policy-option" class="headerlink" title="set block-policy option"></a>set block-policy option</h3><p>设定过滤规则中指定的block动作的默认行为。 注意单独的过滤规则可以重写默认的响应。 </p>
<ul>
<li>drop - 数据包悄然丢弃. </li>
<li>return - TCP RST 数据包返回给遭阻塞的TCP数据包，ICMP不可到达数据包返回给其他。 </li>
</ul>
<h3 id="set-debug-option"><a href="#set-debug-option" class="headerlink" title="set debug option"></a>set debug option</h3><p>设定pf的调试级别。 </p>
<ul>
<li>none - 不显示任何调试信息。 </li>
<li>urgent - 为严重错误产生调试信息，这是默认选择。 </li>
<li>misc - 为多种错误产生调试信息。（例如，收到标准化/整形的数据包的状态，和产生失败的状态）。. </li>
<li>loud - 为普通条件产生调试信息（例如，收到被动操作系统检测信息状态）。 </li>
</ul>
<h3 id="set-fingerprints-file"><a href="#set-fingerprints-file" class="headerlink" title="set fingerprints file"></a>set fingerprints file</h3><p>设定应该装入的进行操作系统识别的操作系统特征文件来，默认是 /etc/pf.os. </p>
<h3 id="set-limit-option-value"><a href="#set-limit-option-value" class="headerlink" title="set limit option value"></a>set limit option value</h3><ul>
<li>frags - 在内存池中进行数据包重组的最大数目。默认是5000。 </li>
<li>src-nodes - 在内存池中用于追踪源地址（由stick－address 和 source-track选项产生）的最大数目，默认是10000。 </li>
<li>states - 在内存池中用于状态表（过滤规则中的keep state）的最大数目，默认是10000。</li>
</ul>
<h3 id="set-loginterface-interface"><a href="#set-loginterface-interface" class="headerlink" title="set loginterface interface"></a>set loginterface interface</h3><p>设定PF要统计进/出流量和放行/阻塞的数据包数目的接口。同一时间只能统计一个接口。注意不管loginterface是否设置，match、bad-offset等计数器和状态表计数器总会被记录。 </p>
<h3 id="set-optimization-option"><a href="#set-optimization-option" class="headerlink" title="set optimization option"></a>set optimization option</h3><p>为以下的网络环境优化PF： </p>
<ul>
<li>normal - 适用于绝大多数网络，这是默认项。 </li>
<li>high-latency - 高延时网络，例如卫星连接。 </li>
<li>aggressive - 自状态表中主动终止连接。这可以大大减少繁忙防火墙的内存需求，但要冒空闲连接被过早断开的风险。 </li>
<li>conservative - 特别保守的设置。这可以避免在内存需求过大时断开空闲连接，会稍微增加CPU的利用率。 </li>
</ul>
<h3 id="set-ruleset-optimization-option"><a href="#set-ruleset-optimization-option" class="headerlink" title="set ruleset-optimization option"></a>set ruleset-optimization option</h3><p>Control operation of the PF ruleset optimizer.</p>
<ul>
<li>none - disable the optimizer altogether.</li>
<li>basic - enables the following ruleset optimizations:</li>
</ul>
<ol>
<li>remove duplicate rules</li>
<li>remove rules that are a subset of another rule</li>
<li>combine multiple rules into a table when advantageous </li>
<li>re-order the rules to improve evaluation performance</li>
</ol>
<ul>
<li>profile - uses the currently loaded ruleset as a feedback profile to tailor the ordering of quick rules to actual network traffic.<br>Starting in OpenBSD 4.2, the default is basic. See pf.conf(5) for a more complete description.</li>
</ul>
<h3 id="set-skip-on-interface"><a href="#set-skip-on-interface" class="headerlink" title="set skip on interface"></a>set skip on interface</h3><p>Skip all PF processing on interface. This can be useful on loopback interfaces where filtering, normalization, queueing, etc, are not required. This option can be used multiple times. By default this option is not set.</p>
<h3 id="set-state-policy-option"><a href="#set-state-policy-option" class="headerlink" title="set state-policy option"></a>set state-policy option</h3><p>设定PF在状态保持时的行为。这种行为可以被单条规则所改变。</p>
<ul>
<li>if-bound - 状态绑定到产生它们的接口。如果流量匹配状态表种条目但不是由条目中记录的接口通过，这个匹配会失败。数据包要么匹配一条过滤规则，或者被丢弃/拒绝。 </li>
<li>group-bound - 行为基本和if-bound相同，除了数据包允许由同一组接口通过，例如所有的ppp接口等。 </li>
<li>floating - 状态可以匹配任何接口上的流量。只要数据包匹配状态表条目，不管是否匹配它通过的接口，都会放行。这是默认的规则。 </li>
</ul>
<h3 id="set-timeout-option-value"><a href="#set-timeout-option-value" class="headerlink" title="set timeout option value"></a>set timeout option value</h3><ul>
<li>interval - seconds between purges of expired states and packet fragments. The default is 10.</li>
<li>frag - seconds before an unassembled fragment is expired. The default is 30.</li>
<li>src.track - seconds to keep a source tracking entry in memory after the last state expires. The default is 0 (zero).</li>
</ul>
<p>例如:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> timeout interval 10</span><br><span class="line"><span class="built_in">set</span> timeout frag 30</span><br><span class="line"><span class="built_in">set</span> <span class="built_in">limit</span> &#123; frags 5000, states 2500 &#125; </span><br><span class="line"><span class="built_in">set</span> optimization high-latency</span><br><span class="line"><span class="built_in">set</span> block-policy <span class="built_in">return</span></span><br><span class="line"><span class="built_in">set</span> loginterface dc0</span><br><span class="line"><span class="built_in">set</span> fingerprints <span class="string">"/etc/pf.os.test"</span> </span><br><span class="line"><span class="built_in">set</span> skip on lo0</span><br><span class="line"><span class="built_in">set</span> state-policy <span class="keyword">if</span>-bound</span><br></pre></td></tr></table></figure></p>
<h2 id="流量整形-数据包标准化"><a href="#流量整形-数据包标准化" class="headerlink" title="流量整形 (数据包标准化)"></a>流量整形 (数据包标准化)</h2><p>流量整形是将数据包标准化避免最终的数据包出现非法的目的。流量整形指引同时也会重组数据包碎片，保护某些操作系统免受某些攻击，丢弃某些带有非法联合标记的TCP数据包。</p>
<p><code>scrub in all</code>  对所有接口上的数据包进行流量整形。</p>
<h3 id="选项"><a href="#选项" class="headerlink" title="选项"></a>选项</h3><ul>
<li>no-df <blockquote>
<p>  在IP数据包头中清除不分片位的设置。某些操作系统已知产生设置不分片位的分片数据包。尤其是对于NFS。流量整形（scrub）会丢弃这类数据包除非设 置了no-df选项。某些操作系统产生带有不分片位和用0填写IP包头中分类域，推荐使用no-df和random-id 联合使用解决。 </p>
</blockquote>
</li>
<li>random-id <blockquote>
<p>  用随机值替换某些操作系统输出数据包中使用的可预测IP分类域的值这个选项仅适用于在选择的数据包重组后不进行分片的输入数据包。 </p>
</blockquote>
</li>
<li>min-ttl num <blockquote>
<p>  增加IP包头中的最小存活时间（TTL）。 </p>
</blockquote>
</li>
<li>max-mss num <blockquote>
<p>  增加在TCP数据包头中最大分段值（MSS）。 </p>
</blockquote>
</li>
<li>fragment reassemble <blockquote>
<p>  在传递数据包到过滤引擎前缓冲收到的数据包碎片，重组它们成完整的数据包。优点是过滤规则仅处理完整的数据包，忽略碎片。缺点是需要内存缓冲数据包碎片。这是没有设置分片选项时的默认行为。这也是能和NAT一起工作的唯一分片选项。 </p>
</blockquote>
</li>
<li>fragment crop <blockquote>
<p>  导致重复的碎片被丢弃，重叠的被裁剪。与碎片重组不同，碎片不会被缓冲，而是一到达就直接传递。 </p>
</blockquote>
</li>
<li>fragment drop-ovl <blockquote>
<p>  跟 <code>fragment crop</code> 相似，除了所有重复和重叠的碎片和其他更多的通信碎片一样被丢弃。 </p>
</blockquote>
</li>
<li><p>reassemble tcp </p>
<blockquote>
<p>  TCP连接状态标准化。当使用了 scrub reassemble tcp时，方向（进/出）不用说明，会执行下面的标准化过程： </p>
</blockquote>
<ol>
<li>连接双方都不允许减少它们的IP TTL值。这样做是为了防止攻击者发送数据包到防火墙，影响防火墙保持的连接状态，使数据包在到达目的主机前就过期。所有数据包的TTL都为了这个连接加到了最大值。 </li>
<li>用随机数字调整TCP数据包头中的 RFC1323 时间戳。这可以阻止窃听者推断主机在线的时间和猜测NAT网关后面有多少主机。 </li>
</ol>
</li>
</ul>
<p>示例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scrub <span class="keyword">in</span> on fxp0 all fragment reassemble min-ttl 15 max-mss 1400 scrub <span class="keyword">in</span> on fxp0 all no-df</span><br><span class="line">scrub on fxp0 all reassemble tcp</span><br></pre></td></tr></table></figure></p>
<h2 id="锚（Anchors）"><a href="#锚（Anchors）" class="headerlink" title="锚（Anchors）"></a>锚（Anchors）</h2><p>除了主规则集，PF也提供子规则集。 由于子规则集能通过pfctl动态操作，所以可以通过子规则集动态的调整filter、nat、rdr和binat规则。</p>
<p>子规则集通过使用锚（Anchor）来附加到主规则集。有四种类型的anchor 规则：</p>
<ul>
<li>anchor name - evaluate(解析)锚中的所有过滤器规则</li>
<li>binat-anchor name - 评估锚名称中的所有binat规则</li>
<li>nat-anchor name - 评估锚名称中的所有nat规则</li>
<li>rdr-anchor name - 评估锚名称中的所有rdr规则</li>
</ul>
<p>Anchor可以嵌套，允许子规则集串联起来。anchor规则在当前位置进行解析，也就是说锚点下的规则是受限于锚规则的。(大概理解)</p>
<h3 id="Anchors"><a href="#Anchors" class="headerlink" title="Anchors"></a>Anchors</h3><p>anchor是一个<code>过滤器</code>和/或<code>转换规则</code>、<code>表</code>、其他<code>anchors</code>的集合，并进行了命名。 当PF在主规则集中遇到anchor规则时，它将评估(evaluate)anchor中包含的规则。</p>
<p>示例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ext_if = <span class="string">"fxp0"</span></span><br><span class="line">block on <span class="variable">$ext_if</span> all    <span class="comment"># 默认拒绝所有的进出流量。</span></span><br><span class="line">pass out on <span class="variable">$ext_if</span> all keep state anchor goodguys  <span class="comment"># 允许符合goodguys锚规则的流量出。</span></span><br></pre></td></tr></table></figure></p>
<p>anchor的三种使用方式：</p>
<ul>
<li><p>using a load rule</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从文本文件中读取规则，并声明一个名称。先声明anchor名称，再载入规则。</span></span><br><span class="line"></span><br><span class="line">anchor goodguys     <span class="comment"># 声明anchor名称</span></span><br><span class="line">load anchor goodguys from <span class="string">"/etc/anchor-goodguys-ssh"</span>    <span class="comment"># 为anchor载入具体的规则</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>using pfctl</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">echo</span> <span class="string">"pass in proto tcp from 192.0.2.3 to any port 22"</span> | pfctl -a goodguys -f -</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以从文本中载入</span></span><br><span class="line">&gt; cat &gt;&gt; /etc/anchor-goodguys-www</span><br><span class="line">pass <span class="keyword">in</span> proto tcp from 192.0.2.3 to any port 80</span><br><span class="line">pass <span class="keyword">in</span> proto tcp from 192.0.2.4 to any port &#123; 80 443 &#125;</span><br><span class="line">&gt; pfctl -a goodguys -f /etc/anchor-goodguys-www</span><br></pre></td></tr></table></figure>
</li>
<li><p>内联规则</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">allow = <span class="string">"&#123; 192.0.2.3 192.0.2.4 &#125;"</span></span><br><span class="line">anchor <span class="string">"goodguys"</span> &#123; </span><br><span class="line">    anchor &#123;    <span class="comment"># 内联anchor可以匿名</span></span><br><span class="line">        pass <span class="keyword">in</span> proto tcp from 192.0.2.3 to port 80 </span><br><span class="line">    &#125;</span><br><span class="line">    pass <span class="keyword">in</span> proto tcp from <span class="variable">$allow</span> to port 22    <span class="comment">#宏变量不可以跨anchor读取,此处为内联anchor，可行。</span></span><br><span class="line">&#125;</span><br><span class="line">------------------</span><br><span class="line"><span class="comment"># 由于锚可以嵌套，因此可以指定子锚。</span></span><br><span class="line">anchor <span class="string">"spam/*"</span>     <span class="comment"># 锚内所有规则。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 锚内执行的操作只作用于本锚内规则。另外，主规则集内移除锚点不会清除依存于该锚的规则和子锚。除非使用 pfctl -F 进行flush。</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="锚定选项"><a href="#锚定选项" class="headerlink" title="锚定选项"></a>锚定选项</h3><p>配置ssh锚，声明只允许通过来之fxp0接口的22端口流量。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ext_if = <span class="string">"fxp0"</span></span><br><span class="line">block on <span class="variable">$ext_if</span> all</span><br><span class="line">pass out on <span class="variable">$ext_if</span> all keep state</span><br><span class="line">anchor ssh <span class="keyword">in</span> on <span class="variable">$ext_if</span> proto tcp from any to any port 22</span><br></pre></td></tr></table></figure></p>
<p>后续添加的ssh锚中的规则如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">echo</span> <span class="string">"pass in from 192.0.2.10 to any"</span> | pfctl -a ssh -f -</span><br></pre></td></tr></table></figure></p>
<p>尽管这个规则没有指定接口、协议、端口，但由于ssh锚规则的定义，所以192.0.2.10只能连接SSH。</p>
<p>同样的语法能用于内联anchor。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">allow = <span class="string">"&#123; 192.0.2.3 192.0.2.4 &#125;"</span></span><br><span class="line">anchor <span class="string">"goodguys"</span> <span class="keyword">in</span> proto tcp &#123;        <span class="comment"># tcp 入流量</span></span><br><span class="line">    anchor proto tcp to port 80 &#123;       <span class="comment"># to80端口</span></span><br><span class="line">        pass from 192.0.2.3             <span class="comment"># from 192.0.2.3 通过</span></span><br><span class="line">    &#125;   <span class="comment"># 合起来就是：允许192.0.2.3访问内部的tcp 80。</span></span><br><span class="line">    anchor proto tcp to port 22 &#123; </span><br><span class="line">        pass from <span class="variable">$allow</span></span><br><span class="line">    &#125;   <span class="comment"># 允许192.0.2.3和192.0.2.4访问内部的tcp 22。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="操作已命名规则集"><a href="#操作已命名规则集" class="headerlink" title="操作已命名规则集"></a>操作已命名规则集</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; pfctl -a ssh -s rules     <span class="comment"># 罗列ssh锚中的过滤规则</span></span><br><span class="line">&gt; pfctl -a ssh -F rules     <span class="comment"># 刷新ssh锚中的过滤规则</span></span><br></pre></td></tr></table></figure>
<h2 id="日志（Logging）（略）"><a href="#日志（Logging）（略）" class="headerlink" title="日志（Logging）（略）"></a>日志（Logging）（略）</h2><h2 id="FTP问题（Issues-with-FTP）-略"><a href="#FTP问题（Issues-with-FTP）-略" class="headerlink" title="FTP问题（Issues with FTP） (略)"></a>FTP问题（Issues with FTP） (略)</h2><hr>
<p>参考资料：</p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZWJzZGNoaW5hLm9yZy9mb3J1bS90b3BpY18yNDY0MS5odG1s" title="https://www.freebsdchina.org/forum/topic_24641.html">https://www.freebsdchina.org/forum/topic_24641.html<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cDovL211cnVzZmlyZXdhbGwuY29tL0RvY3VtZW50YXRpb24vT1MlMjBYJTIwUEYlMjBNYW51YWwucGRm" title="http://murusfirewall.com/Documentation/OS%20X%20PF%20Manual.pdf">http://murusfirewall.com/Documentation/OS%20X%20PF%20Manual.pdf<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9tYW4ub3BlbmJzZC5vcmcvcGZjdGw=" title="https://man.openbsd.org/pfctl">https://man.openbsd.org/pfctl<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9pa2F3bm9jbGFzdC5jb20vc2VjdXJpdHkvbWFjLW9zLXgtcGYtZmlyZXdhbGwtYXZvaWRpbmcta25vd24tYmFkLWd1eXMv" title="https://ikawnoclast.com/security/mac-os-x-pf-firewall-avoiding-known-bad-guys/">https://ikawnoclast.com/security/mac-os-x-pf-firewall-avoiding-known-bad-guys/<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cDovL3d3dy5oYW55bmV0LmNvbS9pY2VmbG9vci8=" title="http://www.hanynet.com/icefloor/">http://www.hanynet.com/icefloor/<i class="fa fa-external-link"></i></span></p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/pf/" rel="tag"># pf</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/智能硬件安全一瞥/" rel="next" title="智能硬件安全一瞥">
                <i class="fa fa-chevron-left"></i> 智能硬件安全一瞥
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/Traffic-Interception-By-Soft-Router/" rel="prev" title="软路由实现流量拦截">
                软路由实现流量拦截 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Mr.Bingo</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">39</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">29</span>
                    <span class="site-state-item-name">tags</span>
                  
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL29kYm95" title="GitHub &rarr; https://github.com/odboy"><i class="fa fa-fw fa-github"></i>GitHub</span>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:bingo@oddboy.cn" title="E-Mail &rarr; mailto:bingo@oddboy.cn"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <span class="exturl" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9PZGRCb3lDTg==" title="Twitter &rarr; https://twitter.com/OddBoyCN"><i class="fa fa-fw fa-twitter"></i>Twitter</span>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <span class="exturl" data-url="aHR0cHM6Ly93ZWliby5jb20vdS81MDE3Mzc5ODQ0" title="Weibo &rarr; https://weibo.com/u/5017379844"><i class="fa fa-fw fa-weibo"></i>Weibo</span>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#开始"><span class="nav-number">1.</span> <span class="nav-text">开始</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#激活"><span class="nav-number">1.1.</span> <span class="nav-text">激活</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置"><span class="nav-number">1.2.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#控制"><span class="nav-number">1.3.</span> <span class="nav-text">控制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#列表和宏"><span class="nav-number">2.</span> <span class="nav-text">列表和宏</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#列表-Lists"><span class="nav-number">2.1.</span> <span class="nav-text">列表 - Lists</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#宏-Macros"><span class="nav-number">2.2.</span> <span class="nav-text">宏 - Macros</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#表-Table"><span class="nav-number">3.</span> <span class="nav-text">表 - Table</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#表配置"><span class="nav-number">3.1.</span> <span class="nav-text">表配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#命令操作"><span class="nav-number">3.2.</span> <span class="nav-text">命令操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#指定地址"><span class="nav-number">3.3.</span> <span class="nav-text">指定地址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#地址匹配"><span class="nav-number">3.4.</span> <span class="nav-text">地址匹配</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#包过滤"><span class="nav-number">4.</span> <span class="nav-text">包过滤</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#规则语法"><span class="nav-number">4.1.</span> <span class="nav-text">规则语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#默认拒绝"><span class="nav-number">4.2.</span> <span class="nav-text">默认拒绝</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通过流量"><span class="nav-number">4.3.</span> <span class="nav-text">通过流量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#quick关键字"><span class="nav-number">4.4.</span> <span class="nav-text">quick关键字</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#状态保持"><span class="nav-number">4.5.</span> <span class="nav-text">状态保持</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UDP状态保持"><span class="nav-number">4.6.</span> <span class="nav-text">UDP状态保持</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#状态跟踪"><span class="nav-number">4.7.</span> <span class="nav-text">状态跟踪</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TCP标记"><span class="nav-number">4.8.</span> <span class="nav-text">TCP标记</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TCP-SYN-代理-（os-X下不稳定）"><span class="nav-number">4.9.</span> <span class="nav-text">TCP SYN 代理 （os X下不稳定）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#阻塞欺骗数据包"><span class="nav-number">4.10.</span> <span class="nav-text">阻塞欺骗数据包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Unicast-Reverse-Path-Forwarding"><span class="nav-number">4.11.</span> <span class="nav-text">Unicast Reverse Path Forwarding</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#被动操作系统识别"><span class="nav-number">4.12.</span> <span class="nav-text">被动操作系统识别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IP-选项"><span class="nav-number">4.13.</span> <span class="nav-text">IP 选项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#过滤规则实例"><span class="nav-number">4.14.</span> <span class="nav-text">过滤规则实例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NAT-网络地址转换"><span class="nav-number">5.</span> <span class="nav-text">NAT(网络地址转换)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#NAT如何工作"><span class="nav-number">5.1.</span> <span class="nav-text">NAT如何工作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NAT和包过滤"><span class="nav-number">5.2.</span> <span class="nav-text">NAT和包过滤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IP转发"><span class="nav-number">5.3.</span> <span class="nav-text">IP转发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置NAT"><span class="nav-number">5.4.</span> <span class="nav-text">配置NAT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#双向映射-1-1-映射"><span class="nav-number">5.5.</span> <span class="nav-text">双向映射 (1:1 映射)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#转换规则例外"><span class="nav-number">5.6.</span> <span class="nav-text">转换规则例外</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查-NAT-状态"><span class="nav-number">5.7.</span> <span class="nav-text">检查 NAT 状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#重定向-端口转发"><span class="nav-number">6.</span> <span class="nav-text">重定向 (端口转发)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#重定向和包过滤"><span class="nav-number">6.1.</span> <span class="nav-text">重定向和包过滤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安全隐患-略"><span class="nav-number">6.2.</span> <span class="nav-text">安全隐患(略)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#重定向和反射"><span class="nav-number">6.3.</span> <span class="nav-text">重定向和反射</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#规则生成捷径"><span class="nav-number">7.</span> <span class="nav-text">规则生成捷径</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用宏-略"><span class="nav-number">7.1.</span> <span class="nav-text">使用宏 (略)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用列表-略"><span class="nav-number">7.2.</span> <span class="nav-text">使用列表 (略)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PF-语法"><span class="nav-number">7.3.</span> <span class="nav-text">PF 语法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#运行选项"><span class="nav-number">8.</span> <span class="nav-text">运行选项</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#set-block-policy-option"><span class="nav-number">8.1.</span> <span class="nav-text">set block-policy option</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#set-debug-option"><span class="nav-number">8.2.</span> <span class="nav-text">set debug option</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#set-fingerprints-file"><span class="nav-number">8.3.</span> <span class="nav-text">set fingerprints file</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#set-limit-option-value"><span class="nav-number">8.4.</span> <span class="nav-text">set limit option value</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#set-loginterface-interface"><span class="nav-number">8.5.</span> <span class="nav-text">set loginterface interface</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#set-optimization-option"><span class="nav-number">8.6.</span> <span class="nav-text">set optimization option</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#set-ruleset-optimization-option"><span class="nav-number">8.7.</span> <span class="nav-text">set ruleset-optimization option</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#set-skip-on-interface"><span class="nav-number">8.8.</span> <span class="nav-text">set skip on interface</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#set-state-policy-option"><span class="nav-number">8.9.</span> <span class="nav-text">set state-policy option</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#set-timeout-option-value"><span class="nav-number">8.10.</span> <span class="nav-text">set timeout option value</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#流量整形-数据包标准化"><span class="nav-number">9.</span> <span class="nav-text">流量整形 (数据包标准化)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#选项"><span class="nav-number">9.1.</span> <span class="nav-text">选项</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#锚（Anchors）"><span class="nav-number">10.</span> <span class="nav-text">锚（Anchors）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Anchors"><span class="nav-number">10.1.</span> <span class="nav-text">Anchors</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#锚定选项"><span class="nav-number">10.2.</span> <span class="nav-text">锚定选项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#操作已命名规则集"><span class="nav-number">10.3.</span> <span class="nav-text">操作已命名规则集</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#日志（Logging）（略）"><span class="nav-number">11.</span> <span class="nav-text">日志（Logging）（略）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FTP问题（Issues-with-FTP）-略"><span class="nav-number">12.</span> <span class="nav-text">FTP问题（Issues with FTP） (略)</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">  <span class="exturl" data-url="aHR0cDovL3d3dy5taWl0YmVpYW4uZ292LmNu">京ICP备18031815号 </span>&copy; 2017 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mr.Bingo</span>

  

  
</div>









        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/schemes/muse.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  
  <script src="/js/src/exturl.js?v=7.0.1"></script>


  

  


  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
