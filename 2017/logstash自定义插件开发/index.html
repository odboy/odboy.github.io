<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.1" color="#222">


  <link rel="manifest" href="/images/manifest.json">


  <meta name="msapplication-config" content="/images/browserconfig.xml">





<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.1.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="本文主要参考官方文档(How to write a Logstash filter plugin)进行实践。 前面因为Logstash是用ruby开发的，所以插件也需要用ruby语言进行开发。相关入门 https://www.ruby-lang.org/en/documentation/quickstart/">
<meta name="keywords" content="ELK">
<meta property="og:type" content="article">
<meta property="og:title" content="logstash自定义过滤器插件开发入门">
<meta property="og:url" content="https://oddboy.cn/2017/logstash自定义插件开发/index.html">
<meta property="og:site_name" content="Mr.Bingo&#39;s Blog">
<meta property="og:description" content="本文主要参考官方文档(How to write a Logstash filter plugin)进行实践。 前面因为Logstash是用ruby开发的，所以插件也需要用ruby语言进行开发。相关入门 https://www.ruby-lang.org/en/documentation/quickstart/">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://oddboy.cn/2017/logstash自定义插件开发/image02.png">
<meta property="og:updated_time" content="2019-03-13T06:36:07.843Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="logstash自定义过滤器插件开发入门">
<meta name="twitter:description" content="本文主要参考官方文档(How to write a Logstash filter plugin)进行实践。 前面因为Logstash是用ruby开发的，所以插件也需要用ruby语言进行开发。相关入门 https://www.ruby-lang.org/en/documentation/quickstart/">
<meta name="twitter:image" content="https://oddboy.cn/2017/logstash自定义插件开发/image02.png">





  
  
  <link rel="canonical" href="https://oddboy.cn/2017/logstash自定义插件开发/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>logstash自定义过滤器插件开发入门 | Mr.Bingo's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Mr.Bingo's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">The world is a narrow bridge, and the most important thing is not to be afraid.</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://oddboy.cn/2017/logstash自定义插件开发/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr.Bingo">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mr.Bingo's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">logstash自定义过滤器插件开发入门

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-11-13 09:30:22" itemprop="dateCreated datePublished" datetime="2017-11-13T09:30:22+08:00">2017-11-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-03-13 14:36:07" itemprop="dateModified" datetime="2019-03-13T14:36:07+08:00">2019-03-13</time>
              
            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/2017/logstash自定义插件开发/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/logstash自定义插件开发/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>本文主要参考官方文档(<span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9sb2dzdGFzaC9jdXJyZW50L19ob3dfdG9fd3JpdGVfYV9sb2dzdGFzaF9maWx0ZXJfcGx1Z2luLmh0bWw=" title="https://www.elastic.co/guide/en/logstash/current/_how_to_write_a_logstash_filter_plugin.html">How to write a Logstash filter plugin<i class="fa fa-external-link"></i></span>)进行实践。</p>
<h2 id="前面"><a href="#前面" class="headerlink" title="前面"></a>前面</h2><p>因为Logstash是用ruby开发的，所以插件也需要用ruby语言进行开发。<br>相关入门 <span class="exturl" data-url="aHR0cHM6Ly93d3cucnVieS1sYW5nLm9yZy9lbi9kb2N1bWVudGF0aW9uL3F1aWNrc3RhcnQv" title="https://www.ruby-lang.org/en/documentation/quickstart/">https://www.ruby-lang.org/en/documentation/quickstart/<i class="fa fa-external-link"></i></span><br><a id="more"></a></p>
<ul>
<li>Ruby</li>
<li>RVM       Ruby Version Manager 版本管理</li>
<li>Rails     开发框架，应该类似于Django之类</li>
<li>RubyGems  Ruby程序包管理器(package manager),类似RedHat的RPM,将一个Ruby应用程序打包到一个gem里。</li>
<li>Gem       Gem是封装起来的Ruby应用程序或代码库。 注：在终端使用的gem命令，是指通过RubyGems管理Gem包。</li>
<li>Gemfile   定义应用所依赖的第三方包，bundle根据该配置去寻找这些包。</li>
<li>Rake      Rake是一门构建语言，和make类似。Rake是用Ruby写的，它支持自己的DSL用来处理和维护Ruby程序。</li>
<li>Rakefile  Rakefile是由Ruby编写，Rake命令执行的就是由Rakefile文件定义的。</li>
<li>Bundle    相当于多个RubyGems批处理运行。在配置文件gemfilel里说明你的应用依赖哪些第三方包，他自动帮你下载安装多个包，并且会下载这些包依赖的包。感觉类似于pip</li>
<li>JRuby     一个采用纯Java实现的Ruby解释器</li>
</ul>
<p>如有必要，参考官方的filter是一个很好的选择。  <span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9sb2dzdGFzaC9jdXJyZW50L2ZpbHRlci1wbHVnaW5zLmh0bWw=" title="https://www.elastic.co/guide/en/logstash/current/filter-plugins.html">https://www.elastic.co/guide/en/logstash/current/filter-plugins.html<i class="fa fa-external-link"></i></span><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用命令行查看当前已安装的插件</span></span><br><span class="line">bingo@U:/usr/share/logstash$ logstash-plugin list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找插件插件文件路径</span></span><br><span class="line">bingo@U:/usr/share/logstash$ find ./ | egrep <span class="string">"logstash-filter.*\.gemspec"</span></span><br></pre></td></tr></table></figure></p>
<p>PS：之前将logstash部署在Ubuntu虚拟机上的，为了便于开发，在MAC本机也安装一个(下载ZIP包)</p>
<h2 id="Step-by-step-入门"><a href="#Step-by-step-入门" class="headerlink" title="Step by step 入门"></a>Step by step 入门</h2><h4 id="1-为插件创建新的GitHub库-logstash-filter-test"><a href="#1-为插件创建新的GitHub库-logstash-filter-test" class="headerlink" title="1. 为插件创建新的GitHub库( logstash-filter-test )"></a>1. 为插件创建新的GitHub库( logstash-filter-test )</h4><h4 id="2-使用插件生成工具"><a href="#2-使用插件生成工具" class="headerlink" title="2. 使用插件生成工具"></a>2. 使用插件生成工具</h4><p>logstash-plugin命令的generate子命令可以为新插件生成基础文件。它创建目录结构、gemspec文件及依赖关系，只需要添加好自定义代码就可以了。<br>更多的信息可查阅官方文档：<span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9sb2dzdGFzaC9jdXJyZW50L3BsdWdpbi1nZW5lcmF0b3IuaHRtbA==" title="https://www.elastic.co/guide/en/logstash/current/plugin-generator.html">https://www.elastic.co/guide/en/logstash/current/plugin-generator.html<i class="fa fa-external-link"></i></span></p>
<h4 id="3-拷贝示例代码"><a href="#3-拷贝示例代码" class="headerlink" title="3. 拷贝示例代码"></a>3. 拷贝示例代码</h4><p>除了上述生成代码外，还可以直接拷贝示例代码，以开始编码。</p>
<ul>
<li>将第1步创建的库克隆到本地</li>
<li>克隆广泛example库到本地</li>
<li>清除example库中的git信息后将文件拷贝到个人库目录</li>
<li>重命名插件名<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/odboy/logstash-filter-test.git</span><br><span class="line"></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/logstash-plugins/logstash-filter-example.git</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> logstash-filter-example</span><br><span class="line"></span><br><span class="line">rm -rf .git     <span class="comment"># 移除git信息</span></span><br><span class="line"></span><br><span class="line">cp -R * ../logstash-filter-test</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> ../logstash-filter-test</span><br><span class="line"><span class="comment"># 修改插件名 # 代码和配置文件中的名称也需要一并修改，此处不一一列出</span></span><br><span class="line">mv logstash-filter-example.gemspec logstash-filter-test.gemspec</span><br><span class="line">mv lib/logstash/filters/example.rb lib/logstash/filters/test.rb</span><br><span class="line">mv spec/filters/example_spec.rb spec/filters/test_spec.rb</span><br><span class="line"><span class="comment"># 显示树结构</span></span><br><span class="line">➜  logstash-filter-test git:(master) ✗ tree ./</span><br><span class="line">./</span><br><span class="line">├── CHANGELOG.md</span><br><span class="line">├── CONTRIBUTORS</span><br><span class="line">├── DEVELOPER.md</span><br><span class="line">├── Gemfile</span><br><span class="line">├── LICENSE</span><br><span class="line">├── NOTICE.TXT</span><br><span class="line">├── README.md</span><br><span class="line">├── Rakefile</span><br><span class="line">├── ci</span><br><span class="line">│   ├── build.sh</span><br><span class="line">│   └── setup.sh</span><br><span class="line">├── lib</span><br><span class="line">│   └── logstash</span><br><span class="line">│       └── filters</span><br><span class="line">│           └── test.rb</span><br><span class="line">├── logstash-filter-test.gemspec</span><br><span class="line">└── spec</span><br><span class="line">    ├── filters</span><br><span class="line">    │   └── test_spec.rb</span><br><span class="line">    └── spec_helper.rb</span><br><span class="line"></span><br><span class="line">6 directories, 14 files</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="4-代码解读"><a href="#4-代码解读" class="headerlink" title="4. 代码解读"></a>4. 代码解读</h4><blockquote>
<p>  ./lib/logstash/filters/test.rb<br><figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># encoding: utf-8       # 声明编码</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">"logstash/filters/base"</span>     </span><br><span class="line"><span class="keyword">require</span> <span class="string">"logstash/namespace"</span>        </span><br><span class="line"></span><br><span class="line"><span class="comment"># This example filter will replace the contents of the default</span></span><br><span class="line"><span class="comment"># message field with whatever you specify in the configuration.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># It is only intended to be used as an example.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogStash::Filters::Test</span> &lt; LogStash::Filters::<span class="title">Base</span>    <span class="comment"># 类声明</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Setting the config_name here is required. This is how you</span></span><br><span class="line">  <span class="comment"># configure this filter from your Logstash config.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># filter &#123;</span></span><br><span class="line">  <span class="comment">#   test &#123;</span></span><br><span class="line">  <span class="comment">#     message =&gt; "My message..."</span></span><br><span class="line">  <span class="comment">#   &#125;</span></span><br><span class="line">  <span class="comment"># &#125;</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  config_name <span class="string">"test"</span>    <span class="comment"># 插件名</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Replace the message with this value.</span></span><br><span class="line">  config <span class="symbol">:message</span>, <span class="symbol">:validate</span> =&gt; <span class="symbol">:string</span>, <span class="symbol">:default</span> =&gt; <span class="string">"Hello World!"</span></span><br><span class="line">  <span class="comment"># 参数配置</span></span><br><span class="line">  <span class="comment"># config :variable_name, :validate =&gt; :variable_type, :default =&gt; "Default value", :required =&gt; boolean, :deprecated =&gt; boolean, :obsolete =&gt; string</span></span><br><span class="line">  <span class="comment"># variable_name就是参数的名称了。</span></span><br><span class="line">  <span class="comment"># validate 定义是否进行校验，如果不是指定的类型，在logstash -f xxx --configtest的时候就会报错。它支持多种数据类型，比如:string, :password, :boolean, :number, :array, :hash, :path (a file-system path), :codec (since 1.2.0), :bytes.</span></span><br><span class="line">  <span class="comment"># default 定义参数的默认值</span></span><br><span class="line">  <span class="comment"># required 定义参数是否是必须值</span></span><br><span class="line">  <span class="comment"># deprecated 定义参数的额外信息，比如一个参数不再推荐使用了，就可以通过它给出提示！典型的就是es-output里面的Index_type，当使用这个参数时，就会给出提示：</span></span><br><span class="line">  <span class="comment"># config :index_type, :validate =&gt; :string, :deprecated =&gt; "Please use the 'document_type' setting instead. It has the same effect, but is more appropriately named."</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 过滤器必须实现register和filter方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Logstash中的register方法类似于initialize方法。</span></span><br><span class="line">  public      <span class="comment"># ruby中需要显示声明public</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">register</span></span></span><br><span class="line">    <span class="comment"># Add instance variables</span></span><br><span class="line">  <span class="keyword">end</span> <span class="comment"># def register</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 该filter方法为实际过滤工作发生的地方。在该方法内，可以使用Event对象引用event(事件)数据。</span></span><br><span class="line">  <span class="comment"># Event是在Logstash内部封装数据流的主要对象，并为插件开发人员提供了一个与事件内容交互的API。</span></span><br><span class="line">  <span class="comment"># filter方法还应该通过显示调用Event类中的可用sprintf方法来处理任何“事件相关配置”。</span></span><br><span class="line"></span><br><span class="line">  public</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> @message</span><br><span class="line">      <span class="comment"># Replace the event message with our message as configured in the</span></span><br><span class="line">      <span class="comment"># config file.</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># using the event.set API</span></span><br><span class="line">      event.set(<span class="string">"message"</span>, @message)</span><br><span class="line">      <span class="comment"># correct debugging log statement for reference</span></span><br><span class="line">      <span class="comment"># using the event.get API</span></span><br><span class="line">      @logger.debug? &amp;&amp; @logger.debug(<span class="string">"Message is now: <span class="subst">#&#123;event.get(<span class="string">"message"</span>)&#125;</span>"</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># filter_matched should go in the last line of our successful code</span></span><br><span class="line">    <span class="comment"># 在成功执行插件时调用filter_matched方法将确保通过Logstash配置为此过滤器添加的任何字段或标记都将被正确处理。 例如，此时将执行任何add_field，remove_field，add_tag和/或remove_tag操作。</span></span><br><span class="line">    filter_matched(event)   <span class="comment"># 该方法会把事件传入下一个过滤器</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Event方法（如event.cancel）现在可用于控制正在处理的事件的工作流程。</span></span><br><span class="line">  <span class="keyword">end</span> <span class="comment"># def filter</span></span><br><span class="line"><span class="keyword">end</span> <span class="comment"># class LogStash::Filters::Test</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<h4 id="5-建立插件"><a href="#5-建立插件" class="headerlink" title="5. 建立插件"></a>5. 建立插件</h4><p>在此，我们已经编写好了插件的代码，并准备从中构建一个Ruby Gem。</p>
<ul>
<li><p>外部依赖</p>
<p>  Ruby文件头部的require声明用于包含必要的代码。在某些情况下，我们的插件可能需要额外的文件。 例如，<code>logstash-codec-collectd</code>插件使用“collectd”提供的<code>types.db</code>文件。位于插件主目录中的<code>vendor.json</code>文件描述了这些文件的位置。</p>
<p>  vendor.json文件包含一个JSON对象数组，每个JSON对象描述一个文件依赖关系。这个例子来自<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xvZ3N0YXNoLXBsdWdpbnMvbG9nc3Rhc2gtY29kZWMtY29sbGVjdGQvYmxvYi9tYXN0ZXIvdmVuZG9yLmpzb24=" title="https://github.com/logstash-plugins/logstash-codec-collectd/blob/master/vendor.json">collectd<i class="fa fa-external-link"></i></span>编解码器插件：</p>
  <figure class="highlight"><table><tr><td class="code"><pre><span class="line">[&#123;</span><br><span class="line">    "sha1": "a90fe6cc53b76b7bdd56dc57950d90787cb9c96e",     # 验证URL引用文件的完整性</span><br><span class="line">    "url": "http://collectd.org/files/collectd-5.4.0.tar.gz",   # Logstash下载该文件的地址</span><br><span class="line">    "files": [ "/src/types.db" ]            # 可选项！ 指定从URL对应文件中提取指定文件，如果不指定，所有文件都会被提取出来。</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>
<p>  除了collectd插件外，<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xvZ3N0YXNoLXBsdWdpbnMvbG9nc3Rhc2gtZmlsdGVyLWdlb2lwL2Jsb2IvbWFzdGVyL3ZlbmRvci5qc29u" title="https://github.com/logstash-plugins/logstash-filter-geoip/blob/master/vendor.json">geoip插件<i class="fa fa-external-link"></i></span>也有<code>vendor.json</code>文件</p>
<p>  用于下载这些依赖项的过程是<code>rake vendor</code>，测试部分进一步说明。</p>
<p>  另外一种外部依赖是在jar文件上，这将在“添加gemspec文件”一节中介绍。</p>
</li>
<li><p>添加Gemfile文件</p>
<p>  Gemfile允许Ruby的<span class="exturl" data-url="aHR0cDovL2J1bmRsZXIuaW8vZ2VtZmlsZS5odG1s" title="http://bundler.io/gemfile.html">Bundler<i class="fa fa-external-link"></i></span>维护插件的依赖关系。 目前，我们只需要用于测试的Logstash gem，如需要其他gem，则需要添加到这里。</p>
<p>  从example中拷贝过来的Gemfile文件内容如下：</p>
  <figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">source <span class="string">'https://rubygems.org'</span></span><br><span class="line"></span><br><span class="line">gemspec</span><br><span class="line"></span><br><span class="line">logstash_path = ENV[<span class="string">"LOGSTASH_PATH"</span>] <span class="params">||</span> <span class="string">"../../logstash"</span></span><br><span class="line">use_logstash_source = ENV[<span class="string">"LOGSTASH_SOURCE"</span>] &amp;&amp; ENV[<span class="string">"LOGSTASH_SOURCE"</span>].to_s == <span class="string">"1"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> Dir.exist?(logstash_path) &amp;&amp; use_logstash_source</span><br><span class="line">gem <span class="string">'logstash-core'</span>, <span class="symbol">:path</span> =&gt; <span class="string">"<span class="subst">#&#123;logstash_path&#125;</span>/logstash-core"</span></span><br><span class="line">gem <span class="string">'logstash-core-plugin-api'</span>, <span class="symbol">:path</span> =&gt; <span class="string">"<span class="subst">#&#123;logstash_path&#125;</span>/logstash-core-plugin-api"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">gem <span class="string">"logstash"</span>, <span class="symbol">:github</span> =&gt; <span class="string">"elastic/logstash"</span>, <span class="symbol">:branch</span> =&gt; <span class="string">"5.6"</span> </span><br><span class="line"><span class="comment"># 按照教程额外添加的配置项，否则bundle install时会报错：Could not find gem 'logstash-devutils' in any of the gem sources listed in your Gemfile.    </span></span><br><span class="line"><span class="comment"># 添加该行配置，出现[坑0x02]报错。</span></span><br><span class="line"><span class="comment"># 经查资料，需要jruby.</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>添加gemspec文件</p>
<p>  gemspec定义了将被构建并包含插件的Ruby gem。 <span class="exturl" data-url="aHR0cDovL2d1aWRlcy5ydWJ5Z2Vtcy5vcmcvc3BlY2lmaWNhdGlvbi1yZWZlcmVuY2Uv" title="http://guides.rubygems.org/specification-reference/">http://guides.rubygems.org/specification-reference/<i class="fa fa-external-link"></i></span></p>
  <figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">Gem::Specification.new <span class="keyword">do</span> <span class="params">|s|</span></span><br><span class="line">s.name = <span class="string">'logstash-filter-test'</span></span><br><span class="line">s.version         = <span class="string">'3.0.1'</span></span><br><span class="line">s.licenses = [<span class="string">'Apache License (2.0)'</span>]   <span class="comment"># 如果需要公开插件，则需要添加该license</span></span><br><span class="line">s.summary = <span class="string">"This example filter replaces the contents of the message field with the specified value."</span></span><br><span class="line">s.description     = <span class="string">"This gem is a Logstash plugin required to be installed on top of the Logstash core pipeline using $LS_HOME/bin/logstash-plugin install gemname. This gem is not a stand-alone program"</span></span><br><span class="line">s.authors = [<span class="string">"Mr.Bingo"</span>]</span><br><span class="line">s.email = <span class="string">'bingo@oddboy.cn'</span></span><br><span class="line">s.homepage = <span class="string">"http://oddboy.cn"</span></span><br><span class="line">s.require_paths = [<span class="string">"lib"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Files</span></span><br><span class="line">s.files = Dir[<span class="string">'lib/**/*'</span>,<span class="string">'spec/**/*'</span>,<span class="string">'vendor/**/*'</span>,<span class="string">'*.gemspec'</span>,<span class="string">'*.md'</span>,<span class="string">'CONTRIBUTORS'</span>,<span class="string">'Gemfile'</span>,<span class="string">'LICENSE'</span>,<span class="string">'NOTICE.TXT'</span>]</span><br><span class="line"><span class="comment"># Tests</span></span><br><span class="line">s.test_files = s.files.grep(<span class="regexp">%r&#123;^(test|spec|features)/&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Special flag to let us know this is actually a logstash plugin</span></span><br><span class="line">s.metadata = &#123; <span class="string">"logstash_plugin"</span> =&gt; <span class="string">"true"</span>, <span class="string">"logstash_group"</span> =&gt; <span class="string">"filter"</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Gem dependencies</span></span><br><span class="line">s.add_runtime_dependency <span class="string">"logstash-core-plugin-api"</span>, <span class="string">"~&gt; 2.0"</span></span><br><span class="line">s.add_development_dependency <span class="string">'logstash-devutils'</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>运行及开发依赖</p>
<p>  在gemspec文件的底部是一个带有注释的部分：Gem依赖关系。所有需要依赖的gem都需要在此声明。 插件需要使用的gem添加到运行时依赖项。 如果只是用于测试，则需要添加到开发依赖项。</p>
<p>  <strong>PS：所有插件对logstash-core-plugin-api gem都有运行时依赖，并且对logstash-devutils有开发依赖。</strong></p>
</li>
<li><p>Jar依赖</p>
<p>  在某些情况，例如ElasticSearch的output插件，代码可能会依赖jar文件。在这种情况下，以如下方式在gemspec文件中添加依赖关系。</p>
  <figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Jar dependencies</span></span><br><span class="line">s.requirements &lt;&lt; <span class="string">"jar 'org.elasticsearch:elasticsearch', '5.0.0'"</span></span><br><span class="line">s.add_runtime_dependency <span class="string">'jar-dependencies'</span></span><br></pre></td></tr></table></figure>
<p>  不过在filter插件中一般应该不会用到···</p>
</li>
</ul>
<h4 id="6-调试-测试"><a href="#6-调试-测试" class="headerlink" title="6. 调试/测试"></a>6. 调试/测试</h4><p>既然按照教程添加了GitHub库，最好还是先push一下。<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git add .</span><br><span class="line">git commit -m &quot;从logstash-filter-example拷 贝&quot;</span><br><span class="line">git push</span><br></pre></td></tr></table></figure></p>
<ul>
<li>使用bundler安装依赖<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 将Gemfile中的#source 'https://rubygems.org'  修改为 source 'https://gems.ruby-china.org/'</span></span><br><span class="line"></span><br><span class="line">sudo gem install bundle     <span class="comment"># 安装bundle</span></span><br><span class="line">bundle -v                   <span class="comment"># Bundler version 1.16.0</span></span><br><span class="line"><span class="comment">#rake vendor                # 如果有vendor.json文件需要使用该命令下载依赖文件</span></span><br><span class="line">bundle install              <span class="comment"># 安装依赖</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>坑0x01:<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  logstash-filter-test git:(master) ✗ bundle install</span><br><span class="line">Fetching gem metadata from https://gems.ruby-china.org/..........</span><br><span class="line">Could not find gem <span class="string">'logstash-devutils'</span> <span class="keyword">in</span> any of the gem sources listed <span class="keyword">in</span> your Gemfile.</span><br></pre></td></tr></table></figure></p>
<p>坑0x02:<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  logstash-filter-test git:(master) ✗ bundle install</span><br><span class="line">The git <span class="built_in">source</span> `git://github.com/elastic/logstash.git` uses the `git` protocol, <span class="built_in">which</span> transmits data without encryption. Disable this warning with `bundle config git.allow_insecure <span class="literal">true</span>`, or switch to the `https` protocol to keep your data secure.</span><br><span class="line">Fetching git://github.com/elastic/logstash.git</span><br><span class="line"></span><br><span class="line">[!] There was an error <span class="keyword">while</span> loading `logstash-core-plugin-api.gemspec`: The logstash-core-api need to be build on jruby. Bundler cannot <span class="built_in">continue</span>.</span><br><span class="line"></span><br><span class="line"> <span class="comment">#  from /Users/jason/.bundle/ruby/2.0.0/logstash-01a419793a67/logstash-core-plugin-api/logstash-core-plugin-api.gemspec:27</span></span><br><span class="line"> <span class="comment">#  -------------------------------------------</span></span><br><span class="line"> <span class="comment">#    else</span></span><br><span class="line"> &gt;      raise <span class="string">"The logstash-core-api need to be build on jruby"</span></span><br><span class="line"> <span class="comment">#    end</span></span><br><span class="line"> <span class="comment">#  -------------------------------------------</span></span><br></pre></td></tr></table></figure></p>
<p>尝试解决：(通过RVM安装Jruby)<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt;  vim ~/.zshrc <span class="comment"># 添加JAVA相关环境变量。</span></span><br><span class="line">******************************</span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/Library/Java/JavaVirtualMachines/jdk1.8.0_112.jdk/Contents/Home</span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/lib/dt.jar:<span class="variable">$JAVA_HOME</span>/lib/tools.jar</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line">******************************</span><br><span class="line"></span><br><span class="line"><span class="comment"># https://ruby-china.org/wiki/rvm-guide</span></span><br><span class="line">&gt; rvm install jruby     <span class="comment"># 安装jruby</span></span><br><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">    Searching <span class="keyword">for</span> binary rubies, this might take some time.</span><br><span class="line">    Found remote file https://s3.amazonaws.com/jruby.org/downloads/9.1.13.0/jruby-bin-9.1.13.0.tar.gz</span><br><span class="line">    Checking requirements <span class="keyword">for</span> osx.</span><br><span class="line">    Requirements installation successful.</span><br><span class="line">    jruby-9.1.13.0 - <span class="comment">#configure</span></span><br><span class="line">    jruby-9.1.13.0 - <span class="comment">#download</span></span><br><span class="line">    ** Resuming transfer from byte position 397312</span><br><span class="line">    % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                    Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">    100 19.6M  100 19.6M    0     0  1695k      0  0:00:11  0:00:11 --:--:-- 2474k</span><br><span class="line">    jruby-9.1.13.0 - <span class="comment">#validate archive</span></span><br><span class="line">    jruby-9.1.13.0 - <span class="comment">#extract</span></span><br><span class="line">    jruby-9.1.13.0 - <span class="comment">#validate binary</span></span><br><span class="line">    jruby-9.1.13.0 - <span class="comment">#setup</span></span><br><span class="line">    jruby-9.1.13.0 - <span class="comment">#gemset created /Users/jason/.rvm/gems/jruby-9.1.13.0@global</span></span><br><span class="line">    jruby-9.1.13.0 - <span class="comment">#importing gemset /Users/jason/.rvm/gemsets/jruby/global.gems..</span></span><br><span class="line">    jruby-9.1.13.0 - <span class="comment">#generating global wrappers........</span></span><br><span class="line">    jruby-9.1.13.0 - <span class="comment">#gemset created /Users/jason/.rvm/gems/jruby-9.1.13.0</span></span><br><span class="line">    jruby-9.1.13.0 - <span class="comment">#importing gemsetfile /Users/jason/.rvm/gemsets/default.gems evaluated to empty gem list</span></span><br><span class="line">    jruby-9.1.13.0 - <span class="comment">#generating default wrappers........</span></span><br><span class="line">&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; <span class="comment"># done [rvm install jruby]</span></span><br><span class="line"></span><br><span class="line">&gt; rvm gemset create <span class="built_in">test</span>            <span class="comment"># gemset是一个独立的虚拟gem环境，此处创建一个名为test的gemset.</span></span><br><span class="line"></span><br><span class="line">&gt; jruby -version                    <span class="comment"># 查看jruby版本 （jruby list known) jruby[-9.1.13.0]</span></span><br><span class="line"></span><br><span class="line">&gt; rvm use jruby-9.1.13.0@<span class="built_in">test</span>       <span class="comment"># 为test gemset配置ruby版本</span></span><br><span class="line"></span><br><span class="line">&gt; gem install bundler               <span class="comment"># 安装bundler，否则bundle install会报错：“in `to_specs': Could not find 'bundler' (&gt;= 0) among 16 total gem(s) (Gem::LoadError)”</span></span><br><span class="line"></span><br><span class="line">&gt; bundle install                    <span class="comment"># 安装依赖</span></span><br><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">    Fetching gem metadata from https://gems.ruby-china.org/..........</span><br><span class="line">    Resolving dependencies..................</span><br><span class="line">    Using rake 12.2.1</span><br><span class="line">    Using bundler 1.16.0</span><br><span class="line">    Fetching numerizer 0.1.1</span><br><span class="line">    Installing numerizer 0.1.1</span><br><span class="line">    <span class="comment">#······若干Fetching Installing</span></span><br><span class="line">    Fetching logstash-core 5.5.1.snapshot1 (java)</span><br><span class="line">    Installing logstash-core 5.5.1.snapshot1 (java)</span><br><span class="line">    jar dependencies <span class="keyword">for</span> logstash-core-5.5.1.snapshot1-java.gemspec . . .</span><br><span class="line">        org.apache.logging.log4j:log4j-api:2.6.2:compile</span><br><span class="line">        org.apache.logging.log4j:log4j-core:2.6.2:compile</span><br><span class="line">        com.fasterxml.jackson.core:jackson-core:2.7.4:compile</span><br><span class="line">        com.fasterxml.jackson.core:jackson-databind:2.7.4:compile</span><br><span class="line">        com.fasterxml.jackson.module:jackson-module-afterburner:2.7.4:compile</span><br><span class="line">        com.fasterxml.jackson.dataformat:jackson-dataformat-cbor:2.7.4:compile</span><br><span class="line">    Fetching logstash-core-plugin-api 2.1.27 (java)</span><br><span class="line">    Installing logstash-core-plugin-api 2.1.27 (java)</span><br><span class="line">    <span class="comment">#······若干Fetching Installing</span></span><br><span class="line">    Fetching logstash-devutils 1.3.6 (java)</span><br><span class="line">    Installing logstash-devutils 1.3.6 (java)</span><br><span class="line">    Using logstash-filter-test 3.0.1 from <span class="built_in">source</span> at `.`</span><br><span class="line">    Bundle complete! 2 Gemfile dependencies, 53 gems now installed.</span><br><span class="line">    Use `bundle info [gemname]` to see <span class="built_in">where</span> a bundled gem is installed.</span><br><span class="line">    Post-install message from jar-dependencies:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> you want to use the executable lock_jars <span class="keyword">then</span> install ruby-maven gem before using lock_jars</span><br><span class="line"></span><br><span class="line">    $ gem install ruby-maven -v <span class="string">'~&gt; 3.3.11'</span></span><br><span class="line"></span><br><span class="line">    or add it as a development dependency to your Gemfile</span><br><span class="line"></span><br><span class="line">    gem <span class="string">'ruby-maven'</span>, <span class="string">'~&gt; 3.3.11'</span></span><br><span class="line">&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;   <span class="comment"># done [bundle install]</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>运行tests:<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; bundle exec rspec</span><br><span class="line"></span><br><span class="line">    --- jar coordinate com.fasterxml.jackson.core:jackson-databind already loaded with version 2.7.4 - omit version 2.9.1</span><br><span class="line">    --- jar coordinate com.fasterxml.jackson.core:jackson-annotations already loaded with version 2.7.0 - omit version 2.9.1</span><br><span class="line">    --- jar coordinate com.fasterxml.jackson.module:jackson-module-afterburner already loaded with version 2.7.4 - omit version 2.9.1</span><br><span class="line">    --- jar coordinate com.fasterxml.jackson.core:jackson-core already loaded with version 2.7.4 - omit version 2.9.1</span><br><span class="line">    ERROR StatusLogger No log4j2 configuration file found. Using default configuration: logging only errors to the console.</span><br><span class="line">    Sending Logstash&apos;s logs to  which is now configured via log4j2.properties</span><br><span class="line">    Run options: exclude &#123;:redis=&gt;true, :socket=&gt;true, :performance=&gt;true, :couchdb=&gt;true, :elasticsearch=&gt;true, :elasticsearch_secure=&gt;true, :export_cypher=&gt;true, :integration=&gt;true, :windows=&gt;true&#125;</span><br><span class="line"></span><br><span class="line">    Randomized with seed 42629</span><br><span class="line">    .</span><br><span class="line"></span><br><span class="line">    Finished in 0.25881 seconds (files took 19.52 seconds to load)</span><br><span class="line">    1 example, 0 failures</span><br><span class="line"></span><br><span class="line">    Randomized with seed 42629</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="7-构建-测试"><a href="#7-构建-测试" class="headerlink" title="7. 构建/测试"></a>7. 构建/测试</h4><p>拥有了所有必需的组件，继续运行build命令：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt; gem build logstash-filter-test.gemspec</span><br><span class="line">    WARNING:  license value <span class="string">'Apache License (2.0)'</span> is invalid.  Use a license identifier from</span><br><span class="line">    http://spdx.org/licenses or <span class="string">'Nonstandard'</span> <span class="keyword">for</span> a nonstandard license.</span><br><span class="line">    Did you mean <span class="string">'Apache-2.0'</span>?</span><br><span class="line">    WARNING:  open-ended dependency on logstash-devutils (&gt;= 0, development) is not recommended</span><br><span class="line">    <span class="keyword">if</span> logstash-devutils is semantically versioned, use:</span><br><span class="line">        add_development_dependency <span class="string">'logstash-devutils'</span>, <span class="string">'~&gt; 0'</span></span><br><span class="line">    WARNING:  See http://guides.rubygems.org/specification-reference/ <span class="keyword">for</span> <span class="built_in">help</span></span><br><span class="line">    Successfully built RubyGem</span><br><span class="line">    Name: logstash-filter-test</span><br><span class="line">    Version: 3.0.1</span><br><span class="line">    File: logstash-filter-test-3.0.1.gem  <span class="comment"># gemspec文件中的s.version数字将提供gem版本，在本例中为3.0.1。</span></span><br></pre></td></tr></table></figure></p>
<h4 id="7-安装测试"><a href="#7-安装测试" class="headerlink" title="7. 安装测试"></a>7. 安装测试</h4><ul>
<li><p>安装logstash</p>
<p>  直接从<span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9kb3dubG9hZHMvbG9nc3Rhc2g=" title="https://www.elastic.co/downloads/logstash">官方<i class="fa fa-external-link"></i></span>下载了zip包，解压到<code>/Applications/logstash</code>目录。</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /Applications/logstash</span><br><span class="line">./bin/logstash -V   <span class="comment"># logstash 5.6.4</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用plugin工具安装刚才生成的gem</p>
<p>  使用命令： <code>logstash-plugin install xxx.gem</code></p>
<p>  [坑0x01] 无法连接 rubygems.org</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bin/logstash-plugin install /Users/jason/TempDocs/logstash-filter-test/logstash-filter-test-3.0.1.gem</span><br><span class="line">    Validating /Users/jason/TempDocs/logstash-filter-test/logstash-filter-test-3.0.1.gem</span><br><span class="line">    Installing logstash-filter-test</span><br><span class="line">    WARNING: can not <span class="built_in">set</span> Session<span class="comment">#timeout=(0) no session context</span></span><br><span class="line">    Error Gem::RemoteFetcher::FetchError, retrying 1/10</span><br><span class="line">    too many connection resets (https://rubygems.org/gems/aws-sdk-core-2.3.22.gem)</span><br></pre></td></tr></table></figure>
<p>  [解决处理] 替换官方镜像 <span class="exturl" data-url="aHR0cHM6Ly9nZW1zLnJ1YnktY2hpbmEub3Jn" title="https://gems.ruby-china.org">https://gems.ruby-china.org<i class="fa fa-external-link"></i></span></p>
<ul>
<li>修改~/.gemrc文件，增加<code>ssl_verify_mode: 0</code>配置</li>
<li><code>sudo gem update --system</code> 升级RubyGems 版本</li>
<li><p>替换gem sources - <code>gem sources --add</code>命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">gem sources --add https://gems.ruby-china.org/ --remove https://rubygems.org/</span><br><span class="line">    https://gems.ruby-china.org/ added to sources</span><br><span class="line">    https://rubygems.org/ removed from sources</span><br><span class="line"></span><br><span class="line">gem sources -l</span><br><span class="line">    *** CURRENT SOURCES ***</span><br><span class="line"></span><br><span class="line">    https://gems.ruby-china.org/</span><br></pre></td></tr></table></figure>
</li>
<li><p>替换gem sources - 修改../logstash/Gemfile文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#source "https://rubygems.org"</span></span><br><span class="line"><span class="built_in">source</span> <span class="string">"https://gems.ruby-china.org"</span></span><br></pre></td></tr></table></figure>
<p>安装：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bin/logstash-plugin install /Users/jason/TempDocs/logstash-filter-test/logstash-filter-test-3.0.1.gem</span><br><span class="line">    Validating /Users/jason/TempDocs/logstash-filter-test/logstash-filter-test-3.0.1.gem</span><br><span class="line">    Installing logstash-filter-test</span><br><span class="line">    Installation successful     <span class="comment"># 安装成功</span></span><br><span class="line">bin/logstash-plugin list | grep <span class="built_in">test</span></span><br><span class="line">    logstash-filter-test        <span class="comment"># plugin列表中可查</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>实际测试</p>
<p>  使用命令行传入的简单配置运行Logstash，使用test插件。</p>
  <figure class="highlight plain"><figcaption><span>-e "input &#123; stdin&#123;&#125; &#125; filter &#123; test &#123;&#125; &#125; output &#123;stdout &#123; codec </span></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">![](logstash自定义插件开发/image01.png)</span><br><span class="line"></span><br><span class="line">传入message参数：</span><br><span class="line">```bin/logstash -e &quot;input &#123; stdin&#123;&#125; &#125; filter &#123; test &#123;message =&gt; &apos;changing the message parameter by Mr.Bingo ^_^&apos;&#125; &#125; output &#123;stdout &#123; codec =&gt; rubydebug &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>
<p>  <img src="/2017/logstash自定义插件开发/image02.png" alt></p>
</li>
</ul>
<h2 id="后面"><a href="#后面" class="headerlink" title="后面"></a>后面</h2><p>终于，完成了自定义插件的示例开发与使用。官方文档上还有开源方法，鉴于目前的菜逼水平，完全也没必要看。也许有一天想开源个插件，到时候再来看吧！</p>
<p>接下来，着手WEB攻击日志分析的插件开发。也许从modsecurity取规则是个不错的选择。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9sb2dzdGFzaC9jdXJyZW50L19ob3dfdG9fd3JpdGVfYV9sb2dzdGFzaF9maWx0ZXJfcGx1Z2luLmh0bWw=" title="https://www.elastic.co/guide/en/logstash/current/_how_to_write_a_logstash_filter_plugin.html">How to write a Logstash filter plugin<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cDovL3d3dy5jbmJsb2dzLmNvbS94aW5nOTAxMDIyL3AvNTI1OTc1MC5odG1s" title="http://www.cnblogs.com/xing901022/p/5259750.html">手把手教你编写Logstash插件<i class="fa fa-external-link"></i></span></p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/ELK/" rel="tag"># ELK</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/ELK安装及使用入门/" rel="next" title="ELK安装及使用入门">
                <i class="fa fa-chevron-left"></i> ELK安装及使用入门
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/利用ModSecurity-CRS规则库开发Logstash过滤器插件/" rel="prev" title="<死翘翘了> 利用ModSecurity-CRS规则库开发Logstash过滤器插件">
                <死翘翘了> 利用ModSecurity-CRS规则库开发Logstash过滤器插件 <i class="fa fa-chevron-right"></i>
              </死翘翘了></a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Mr.Bingo</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">41</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL29kYm95" title="GitHub &rarr; https://github.com/odboy"><i class="fa fa-fw fa-github"></i>GitHub</span>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:bingo@oddboy.cn" title="E-Mail &rarr; mailto:bingo@oddboy.cn"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <span class="exturl" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9PZGRCb3lDTg==" title="Twitter &rarr; https://twitter.com/OddBoyCN"><i class="fa fa-fw fa-twitter"></i>Twitter</span>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <span class="exturl" data-url="aHR0cHM6Ly93ZWliby5jb20vdS81MDE3Mzc5ODQ0" title="Weibo &rarr; https://weibo.com/u/5017379844"><i class="fa fa-fw fa-weibo"></i>Weibo</span>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前面"><span class="nav-number">1.</span> <span class="nav-text">前面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step-by-step-入门"><span class="nav-number">2.</span> <span class="nav-text">Step by step 入门</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-为插件创建新的GitHub库-logstash-filter-test"><span class="nav-number">2.0.1.</span> <span class="nav-text">1. 为插件创建新的GitHub库( logstash-filter-test )</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-使用插件生成工具"><span class="nav-number">2.0.2.</span> <span class="nav-text">2. 使用插件生成工具</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-拷贝示例代码"><span class="nav-number">2.0.3.</span> <span class="nav-text">3. 拷贝示例代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-代码解读"><span class="nav-number">2.0.4.</span> <span class="nav-text">4. 代码解读</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-建立插件"><span class="nav-number">2.0.5.</span> <span class="nav-text">5. 建立插件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-调试-测试"><span class="nav-number">2.0.6.</span> <span class="nav-text">6. 调试/测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-构建-测试"><span class="nav-number">2.0.7.</span> <span class="nav-text">7. 构建/测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-安装测试"><span class="nav-number">2.0.8.</span> <span class="nav-text">7. 安装测试</span></a></li></ol></li></ol><li class="nav-item nav-level-2"><a class="nav-link" href="#后面"><span class="nav-number">3.</span> <span class="nav-text">后面</span></a></li></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">  <span class="exturl" data-url="aHR0cDovL3d3dy5iZWlhbi5taWl0Lmdvdi5jbg==">京ICP备18031815号 </span>&copy; 2017 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mr.Bingo</span>

  

  
</div>









        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.1"></script>

  <script src="/js/motion.js?v=7.1.1"></script>



  
  


  <script src="/js/affix.js?v=7.1.1"></script>

  <script src="/js/schemes/pisces.js?v=7.1.1"></script>




  
  <script src="/js/scrollspy.js?v=7.1.1"></script>
<script src="/js/post-details.js?v=7.1.1"></script>



  


  <script src="/js/next-boot.js?v=7.1.1"></script>


  

  
  <script src="/js/exturl.js?v=7.1.1"></script>


  

  
  
  <script id="dsq-count-scr" src="https://blog-jihoat8tps.disqus.com/count.js" async></script>


<script>
  var disqus_config = function() {
    this.page.url = "https://oddboy.cn/2017/logstash自定义插件开发/";
    this.page.identifier = "2017/logstash自定义插件开发/";
    this.page.title = 'logstash自定义过滤器插件开发入门';
    };
  function loadComments() {
    var d = document, s = d.createElement('script');
    s.src = 'https://blog-jihoat8tps.disqus.com/embed.js';
    s.setAttribute('data-timestamp', '' + +new Date());
    (d.head || d.body).appendChild(s);
  }
  
    loadComments();
  
</script>





  


  




  

  

  

  

  

  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>


  

  

  

  

  

  

  

  

</body>
</html>
